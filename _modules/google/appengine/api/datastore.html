

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>google.appengine.api.datastore &mdash; oauth2client 1.4.6 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="oauth2client 1.4.6 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../../index.html" class="fa fa-home"> oauth2client</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/modules.html">oauth2client</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../source/oauth2client.html">oauth2client package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">Contributor License Agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html#before-writing-code-file-an-issue">Before writing code, file an issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html#fork-oauth2client">Fork oauth2client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html#include-tests">Include tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html#make-the-pull-request">Make the pull request</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">oauth2client</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
    <li>google.appengine.api.datastore</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for google.appengine.api.datastore</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># Copyright 2007 Google Inc.</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>
<span class="c">#</span>




<span class="sd">&quot;&quot;&quot;The Python datastore API used by app developers.</span>

<span class="sd">Defines Entity, Query, and Iterator classes, as well as methods for all of the</span>
<span class="sd">datastore&#39;s calls. Also defines conversions between the Python classes and</span>
<span class="sd">their PB counterparts.</span>

<span class="sd">The datastore errors are defined in the datastore_errors module. That module is</span>
<span class="sd">only required to avoid circular imports. datastore imports datastore_types,</span>
<span class="sd">which needs BadValueError, so it can&#39;t be defined in datastore.</span>
<span class="sd">&quot;&quot;&quot;</span>

















<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">xml.sax</span> <span class="kn">import</span> <span class="n">saxutils</span>

<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">apiproxy_stub_map</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">capabilities</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">datastore_errors</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">datastore_types</span>
<span class="kn">from</span> <span class="nn">google.appengine.datastore</span> <span class="kn">import</span> <span class="n">datastore_pb</span>
<span class="kn">from</span> <span class="nn">google.appengine.datastore</span> <span class="kn">import</span> <span class="n">datastore_query</span>
<span class="kn">from</span> <span class="nn">google.appengine.datastore</span> <span class="kn">import</span> <span class="n">datastore_rpc</span>
<span class="kn">from</span> <span class="nn">google.appengine.datastore</span> <span class="kn">import</span> <span class="n">entity_pb</span>



<span class="n">MAX_ALLOWABLE_QUERIES</span> <span class="o">=</span> <span class="mi">30</span>


<span class="n">MAXIMUM_RESULTS</span> <span class="o">=</span> <span class="mi">1000</span>





<span class="n">DEFAULT_TRANSACTION_RETRIES</span> <span class="o">=</span> <span class="mi">3</span>


<span class="n">READ_CAPABILITY</span> <span class="o">=</span> <span class="n">capabilities</span><span class="o">.</span><span class="n">CapabilitySet</span><span class="p">(</span><span class="s">&#39;datastore_v3&#39;</span><span class="p">)</span>
<span class="n">WRITE_CAPABILITY</span> <span class="o">=</span> <span class="n">capabilities</span><span class="o">.</span><span class="n">CapabilitySet</span><span class="p">(</span>
    <span class="s">&#39;datastore_v3&#39;</span><span class="p">,</span>
    <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;write&#39;</span><span class="p">])</span>







<span class="n">_MAX_INDEXED_PROPERTIES</span> <span class="o">=</span> <span class="mi">20000</span>


<span class="n">_MAX_ID_BATCH_SIZE</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">_MAX_ID_BATCH_SIZE</span>

<span class="n">Key</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Key</span>
<span class="n">typename</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">typename</span>


<span class="n">STRONG_CONSISTENCY</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">STRONG_CONSISTENCY</span>
<span class="n">EVENTUAL_CONSISTENCY</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">EVENTUAL_CONSISTENCY</span>



<span class="n">_MAX_INT_32</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="o">-</span><span class="mi">1</span>


<span class="k">def</span> <span class="nf">NormalizeAndTypeCheck</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Normalizes and type checks the given argument.</span>

<span class="sd">  Args:</span>
<span class="sd">    arg: an instance or iterable of the given type(s)</span>
<span class="sd">    types: allowed type or tuple of types</span>

<span class="sd">  Returns:</span>
<span class="sd">    A (list, bool) tuple. The list is a normalized, shallow copy of the</span>
<span class="sd">    argument. The boolean is True if the argument was a sequence, False</span>
<span class="sd">    if it was a single object.</span>

<span class="sd">  Raises:</span>
<span class="sd">    AssertionError: types includes list or tuple.</span>
<span class="sd">    BadArgumentError: arg is not an instance or sequence of one of the given</span>
<span class="sd">    types.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">(</span><span class="n">types</span><span class="p">,)</span>

  <span class="k">assert</span> <span class="nb">list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span> <span class="ow">and</span> <span class="nb">tuple</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">types</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="bp">False</span>
  <span class="k">else</span><span class="p">:</span>


    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
          <span class="s">&#39;Expected an instance or iterable of </span><span class="si">%s</span><span class="s">; received </span><span class="si">%s</span><span class="s"> (a </span><span class="si">%s</span><span class="s">).&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">typename</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>

    <span class="k">try</span><span class="p">:</span>

      <span class="n">arg_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>

      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
          <span class="s">&#39;Expected an instance or iterable of </span><span class="si">%s</span><span class="s">; received </span><span class="si">%s</span><span class="s"> (a </span><span class="si">%s</span><span class="s">).&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">typename</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>


    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">arg_list</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&#39;Expected one of </span><span class="si">%s</span><span class="s">; received </span><span class="si">%s</span><span class="s"> (a </span><span class="si">%s</span><span class="s">).&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">typename</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">arg_list</span><span class="p">,</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">NormalizeAndTypeCheckKeys</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Normalizes and type checks that the given argument is a valid key or keys.</span>

<span class="sd">  A wrapper around NormalizeAndTypeCheck() that accepts strings, Keys, and</span>
<span class="sd">  Entities, and normalizes to Keys.</span>

<span class="sd">  Args:</span>
<span class="sd">    keys: a Key or sequence of Keys</span>

<span class="sd">  Returns:</span>
<span class="sd">    A (list of Keys, bool) tuple. See NormalizeAndTypeCheck.</span>

<span class="sd">  Raises:</span>
<span class="sd">    BadArgumentError: arg is not an instance or sequence of one of the given</span>
<span class="sd">    types.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">keys</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">NormalizeAndTypeCheck</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="p">(</span><span class="nb">basestring</span><span class="p">,</span> <span class="n">Entity</span><span class="p">,</span> <span class="n">Key</span><span class="p">))</span>

  <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">_GetCompleteKeyOrError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">multiple</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">convert_rpc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                         <span class="n">config_class</span><span class="o">=</span><span class="n">datastore_rpc</span><span class="o">.</span><span class="n">Configuration</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Get a Configuration object from the keyword arguments.</span>

<span class="sd">  This is purely an internal helper for the various public APIs below</span>
<span class="sd">  such as Get().</span>

<span class="sd">  Args:</span>
<span class="sd">    kwargs: A dict containing the keyword arguments passed to a public API.</span>
<span class="sd">    convert_rpc: If the an rpc should be converted or passed on directly.</span>
<span class="sd">    config_class: The config class that should be generated.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A UserRPC instance, or a Configuration instance, or None.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError if unexpected keyword arguments are present.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span>


  <span class="n">rpc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;rpc&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">rpc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span> <span class="n">apiproxy_stub_map</span><span class="o">.</span><span class="n">UserRPC</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
        <span class="s">&#39;rpc= argument should be None or a UserRPC instance&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;config&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
          <span class="s">&#39;Expected rpc= or config= argument but not both&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">convert_rpc</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&#39;Unexpected keyword arguments: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">rpc</span>


    <span class="n">read_policy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span> <span class="s">&#39;read_policy&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span>
       <span class="n">deadline</span><span class="o">=</span><span class="n">rpc</span><span class="o">.</span><span class="n">deadline</span><span class="p">,</span> <span class="n">read_policy</span><span class="o">=</span><span class="n">read_policy</span><span class="p">,</span>
       <span class="n">config</span><span class="o">=</span><span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">config_class</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_BaseIndex</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>


  <span class="n">BUILDING</span><span class="p">,</span> <span class="n">SERVING</span><span class="p">,</span> <span class="n">DELETING</span><span class="p">,</span> <span class="n">ERROR</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>




  <span class="n">ASCENDING</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="o">.</span><span class="n">ASCENDING</span>
  <span class="n">DESCENDING</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="o">.</span><span class="n">DESCENDING</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_id</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">has_ancestor</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a datastore index instance.</span>

<span class="sd">    Args:</span>
<span class="sd">      index_id: Required long; Uniquely identifies the index</span>
<span class="sd">      kind: Required string; Specifies the kind of the entities to index</span>
<span class="sd">      has_ancestor: Required boolean; indicates if the index supports a query</span>
<span class="sd">        that filters entities by the entity group parent</span>
<span class="sd">      properties: Required list of (string, int) tuples; The entity properties</span>
<span class="sd">        to index. First item in a tuple is the property name and the second</span>
<span class="sd">        item is the sorting direction (ASCENDING|DESCENDING).</span>
<span class="sd">        The order of the properties is based on the order in the index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">argument_error</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span>
    <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateInteger</span><span class="p">(</span><span class="n">index_id</span><span class="p">,</span> <span class="s">&#39;index_id&#39;</span><span class="p">,</span> <span class="n">argument_error</span><span class="p">,</span>
                                    <span class="n">zero_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateString</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="s">&#39;kind&#39;</span><span class="p">,</span> <span class="n">argument_error</span><span class="p">,</span> <span class="n">empty_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="n">argument_error</span><span class="p">(</span><span class="s">&#39;properties must be a list or a tuple&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">index_property</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">properties</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_property</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">argument_error</span><span class="p">(</span><span class="s">&#39;property[</span><span class="si">%d</span><span class="s">] must be a list or a tuple&#39;</span> <span class="o">%</span> <span class="n">idx</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_property</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">argument_error</span><span class="p">(</span><span class="s">&#39;property[</span><span class="si">%d</span><span class="s">] length should be 2 but was </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_property</span><span class="p">)))</span>
      <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateString</span><span class="p">(</span><span class="n">index_property</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;property name&#39;</span><span class="p">,</span>
                                     <span class="n">argument_error</span><span class="p">)</span>
      <span class="n">_BaseIndex</span><span class="o">.</span><span class="n">__ValidateEnum</span><span class="p">(</span><span class="n">index_property</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">),</span>
                               <span class="s">&#39;sort direction&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__id</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">index_id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__has_ancestor</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">has_ancestor</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__properties</span> <span class="o">=</span> <span class="n">properties</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">__ValidateEnum</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">accepted_values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;value&#39;</span><span class="p">,</span>
                     <span class="n">exception</span><span class="o">=</span><span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">):</span>
    <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateInteger</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">accepted_values</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">exception</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> should be one of </span><span class="si">%s</span><span class="s"> but was </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">accepted_values</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the index id, a long.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id</span>

  <span class="k">def</span> <span class="nf">_Kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the index kind, a string.  Empty string (&#39;&#39;) if none.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kind</span>

  <span class="k">def</span> <span class="nf">_HasAncestor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Indicates if this is an ancestor index, a boolean.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__has_ancestor</span>

  <span class="k">def</span> <span class="nf">_Properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the index properties. a tuple of</span>
<span class="sd">    (index name as a string, [ASCENDING|DESCENDING]) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__properties</span>

  <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">__id</span>

  <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">__id</span>

  <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__id</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">_BaseIndex</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A datastore index.&quot;&quot;&quot;</span>

  <span class="n">Id</span> <span class="o">=</span> <span class="n">_BaseIndex</span><span class="o">.</span><span class="n">_Id</span>
  <span class="n">Kind</span> <span class="o">=</span> <span class="n">_BaseIndex</span><span class="o">.</span><span class="n">_Kind</span>
  <span class="n">HasAncestor</span> <span class="o">=</span> <span class="n">_BaseIndex</span><span class="o">.</span><span class="n">_HasAncestor</span>
  <span class="n">Properties</span> <span class="o">=</span> <span class="n">_BaseIndex</span><span class="o">.</span><span class="n">_Properties</span>


<span class="k">class</span> <span class="nc">DatastoreAdapter</span><span class="p">(</span><span class="n">datastore_rpc</span><span class="o">.</span><span class="n">AbstractAdapter</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Adapter between datatypes defined here (Entity etc.) and protobufs.</span>

<span class="sd">  See the base class in datastore_rpc.py for more docs.</span>
<span class="sd">  &quot;&quot;&quot;</span>


  <span class="n">index_state_mappings</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">entity_pb</span><span class="o">.</span><span class="n">CompositeIndex</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">Index</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
          <span class="n">entity_pb</span><span class="o">.</span><span class="n">CompositeIndex</span><span class="o">.</span><span class="n">DELETED</span><span class="p">:</span> <span class="n">Index</span><span class="o">.</span><span class="n">DELETING</span><span class="p">,</span>
          <span class="n">entity_pb</span><span class="o">.</span><span class="n">CompositeIndex</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">:</span> <span class="n">Index</span><span class="o">.</span><span class="n">SERVING</span><span class="p">,</span>
          <span class="n">entity_pb</span><span class="o">.</span><span class="n">CompositeIndex</span><span class="o">.</span><span class="n">WRITE_ONLY</span><span class="p">:</span> <span class="n">Index</span><span class="o">.</span><span class="n">BUILDING</span>
      <span class="p">}</span>


  <span class="n">index_direction_mappings</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">entity_pb</span><span class="o">.</span><span class="n">Index_Property</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">:</span> <span class="n">Index</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">,</span>
          <span class="n">entity_pb</span><span class="o">.</span><span class="n">Index_Property</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">:</span> <span class="n">Index</span><span class="o">.</span><span class="n">DESCENDING</span>
      <span class="p">}</span>

  <span class="k">def</span> <span class="nf">key_to_pb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">_Key__reference</span>

  <span class="k">def</span> <span class="nf">pb_to_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Key</span><span class="o">.</span><span class="n">_FromPb</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">entity_to_pb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_ToPb</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">pb_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Entity</span><span class="o">.</span><span class="n">_FromPb</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">pb_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="n">index_def</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">definition</span><span class="p">()</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">property</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">),</span>
          <span class="n">DatastoreAdapter</span><span class="o">.</span><span class="n">index_direction_mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">direction</span><span class="p">()))</span>
          <span class="k">for</span> <span class="nb">property</span> <span class="ow">in</span> <span class="n">index_def</span><span class="o">.</span><span class="n">property_list</span><span class="p">()]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">Index</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span> <span class="n">index_def</span><span class="o">.</span><span class="n">entity_type</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">),</span>
                  <span class="n">index_def</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(),</span> <span class="n">properties</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">DatastoreAdapter</span><span class="o">.</span><span class="n">index_state_mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">state</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">state</span>


<span class="n">_adapter</span> <span class="o">=</span> <span class="n">DatastoreAdapter</span><span class="p">()</span>
<span class="n">_thread_local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>


<span class="n">_ENV_KEY</span> <span class="o">=</span> <span class="s">&#39;__DATASTORE_CONNECTION_INITIALIZED__&#39;</span>


<span class="k">def</span> <span class="nf">__InitConnection</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;Internal method to make sure the connection state has been initialized.&quot;&quot;&quot;</span>












  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">_ENV_KEY</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_thread_local</span><span class="p">,</span> <span class="s">&#39;connection_stack&#39;</span><span class="p">):</span>
    <span class="k">return</span>
  <span class="n">_thread_local</span><span class="o">.</span><span class="n">connection_stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">datastore_rpc</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">adapter</span><span class="o">=</span><span class="n">_adapter</span><span class="p">)]</span>

  <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">_ENV_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span>


<span class="k">def</span> <span class="nf">_GetConnection</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;Internal method to retrieve a datastore connection local to the thread.&quot;&quot;&quot;</span>
  <span class="n">__InitConnection</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">_thread_local</span><span class="o">.</span><span class="n">connection_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_SetConnection</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Internal method to replace the current thread local connection.&quot;&quot;&quot;</span>
  <span class="n">__InitConnection</span><span class="p">()</span>
  <span class="n">_thread_local</span><span class="o">.</span><span class="n">connection_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>


<span class="k">def</span> <span class="nf">_PushConnection</span><span class="p">(</span><span class="n">new_connection</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Internal method to save the current connection and sets a new one.</span>

<span class="sd">  Args:</span>
<span class="sd">    new_connection: The connection to set.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">__InitConnection</span><span class="p">()</span>
  <span class="n">_thread_local</span><span class="o">.</span><span class="n">connection_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_connection</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_PopConnection</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;Internal method to restores the previous connection.</span>

<span class="sd">  Returns:</span>
<span class="sd">    The current connection.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_thread_local</span><span class="o">.</span><span class="n">connection_stack</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
  <span class="k">return</span> <span class="n">_thread_local</span><span class="o">.</span><span class="n">connection_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>





<span class="k">def</span> <span class="nf">_MakeSyncCall</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The APIProxy entry point for a synchronous API call.</span>

<span class="sd">  Args:</span>
<span class="sd">    service: For backwards compatibility, must be &#39;datastore_v3&#39;.</span>
<span class="sd">    call: String representing which function to call.</span>
<span class="sd">    request: Protocol buffer for the request.</span>
<span class="sd">    response: Protocol buffer for the response.</span>
<span class="sd">    config: Optional Configuration to use for this request.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Response protocol buffer. Caller should always use returned value</span>
<span class="sd">    which may or may not be same as passed in &#39;response&#39;.</span>

<span class="sd">  Raises:</span>
<span class="sd">    apiproxy_errors.Error or a subclass.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">conn</span> <span class="o">=</span> <span class="n">_GetConnection</span><span class="p">()</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">datastore_pb</span><span class="o">.</span><span class="n">Query</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">_set_request_read_policy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">_set_request_transaction</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
  <span class="n">rpc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">_make_rpc_call</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
  <span class="n">conn</span><span class="o">.</span><span class="n">check_rpc_success</span><span class="p">(</span><span class="n">rpc</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span> <span class="nf">CreateRPC</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="s">&#39;datastore_v3&#39;</span><span class="p">,</span>
              <span class="n">deadline</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">read_policy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create an rpc for use in configuring datastore calls.</span>

<span class="sd">  NOTE: This functions exists for backwards compatibility.  Please use</span>
<span class="sd">  CreateConfig() instead.  NOTE: the latter uses &#39;on_completion&#39;,</span>
<span class="sd">  which is a function taking an argument, wherease CreateRPC uses</span>
<span class="sd">  &#39;callback&#39; which is a function without arguments.</span>

<span class="sd">  Args:</span>
<span class="sd">    service: Optional string; for backwards compatibility, must be</span>
<span class="sd">      &#39;datastore_v3&#39;.</span>
<span class="sd">    deadline: Optional int or float, deadline for calls in seconds.</span>
<span class="sd">    callback: Optional callable, a callback triggered when this rpc</span>
<span class="sd">      completes; takes no arguments.</span>
<span class="sd">    read_policy: Optional read policy; set to EVENTUAL_CONSISTENCY to</span>
<span class="sd">      enable eventually consistent reads (i.e. reads that may be</span>
<span class="sd">      satisfied from an older version of the datastore in some cases).</span>
<span class="sd">      The default read policy may have to wait until in-flight</span>
<span class="sd">      transactions are committed.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A UserRPC instance.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="n">service</span> <span class="o">==</span> <span class="s">&#39;datastore_v3&#39;</span>
  <span class="n">conn</span> <span class="o">=</span> <span class="n">_GetConnection</span><span class="p">()</span>
  <span class="n">config</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">if</span> <span class="n">deadline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="n">deadline</span><span class="o">=</span><span class="n">deadline</span><span class="p">)</span>
  <span class="n">rpc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">_create_rpc</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
  <span class="n">rpc</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
  <span class="k">if</span> <span class="n">read_policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">rpc</span><span class="o">.</span><span class="n">read_policy</span> <span class="o">=</span> <span class="n">read_policy</span>
  <span class="k">return</span> <span class="n">rpc</span>


<span class="k">def</span> <span class="nf">CreateConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create a Configuration object for use in configuring datastore calls.</span>

<span class="sd">  This configuration can be passed to most datastore calls using the</span>
<span class="sd">  &#39;config=...&#39; argument.</span>

<span class="sd">  Args:</span>
<span class="sd">    deadline: Optional deadline; default None (which means the</span>
<span class="sd">      system default deadline will be used, typically 5 seconds).</span>
<span class="sd">    on_completion: Optional callback function; default None.  If</span>
<span class="sd">      specified, it will be called with a UserRPC object as argument</span>
<span class="sd">      when an RPC completes.</span>
<span class="sd">    read_policy: Optional read policy; set to EVENTUAL_CONSISTENCY to</span>
<span class="sd">      enable eventually consistent reads (i.e. reads that may be</span>
<span class="sd">      satisfied from an older version of the datastore in some cases).</span>
<span class="sd">      The default read policy may have to wait until in-flight</span>
<span class="sd">      transactions are committed.</span>
<span class="sd">    **kwds: Other keyword arguments as long as they are supported by</span>
<span class="sd">      datastore_rpc.Configuration().</span>

<span class="sd">  Returns:</span>
<span class="sd">    A datastore_rpc.Configuration instance.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">CreateTransactionOptions</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create a configuration object for use in configuring transactions.</span>

<span class="sd">  This configuration can be passed as run_in_transaction_option&#39;s first</span>
<span class="sd">  argument.</span>

<span class="sd">  Args:</span>
<span class="sd">    deadline: Optional deadline; default None (which means the</span>
<span class="sd">      system default deadline will be used, typically 5 seconds).</span>
<span class="sd">    on_completion: Optional callback function; default None.  If</span>
<span class="sd">      specified, it will be called with a UserRPC object as argument</span>
<span class="sd">      when an RPC completes.</span>
<span class="sd">    xg: set to true to allow cross-group transactions (high replication</span>
<span class="sd">      datastore only)</span>
<span class="sd">    retries: set the number of retries for a transaction</span>
<span class="sd">    **kwds: Other keyword arguments as long as they are supported by</span>
<span class="sd">      datastore_rpc.TransactionOptions().</span>

<span class="sd">  Returns:</span>
<span class="sd">    A datastore_rpc.TransactionOptions instance.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">PutAsync</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously store one or more entities in the datastore.</span>

<span class="sd">  Identical to datastore.Put() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call and get the results.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">extra_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;extra_hook&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&#39;read_policy&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">EVENTUAL_CONSISTENCY</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
        <span class="s">&#39;read_policy is only supported on read operations.&#39;</span><span class="p">)</span>
  <span class="n">entities</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">NormalizeAndTypeCheck</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">Entity</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">is_projection</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
        <span class="s">&#39;Cannot put a partial entity: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">app</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
          <span class="s">&#39;App and kind must not be empty, in entity: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">local_extra_hook</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
    <span class="n">num_keys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="n">num_entities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_keys</span> <span class="o">!=</span> <span class="n">num_entities</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">InternalError</span><span class="p">(</span>
          <span class="s">&#39;Put accepted </span><span class="si">%d</span><span class="s"> entities but returned </span><span class="si">%d</span><span class="s"> keys.&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">num_entities</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_Entity__key</span><span class="o">.</span><span class="n">_Key__reference</span> <span class="o">!=</span> <span class="n">key</span><span class="o">.</span><span class="n">_Key__reference</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">_Entity__key</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">()</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_Entity__key</span><span class="o">.</span><span class="n">_Key__reference</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">_Key__reference</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">multiple</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">keys</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">extra_hook</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">extra_hook</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="k">return</span> <span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">async_put</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">local_extra_hook</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Put</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Store one or more entities in the datastore.</span>

<span class="sd">  The entities may be new or previously existing. For new entities, Put() will</span>
<span class="sd">  fill in the app id and key assigned by the datastore.</span>

<span class="sd">  If the argument is a single Entity, a single Key will be returned. If the</span>
<span class="sd">  argument is a list of Entity, a list of Keys will be returned.</span>

<span class="sd">  Args:</span>
<span class="sd">    entities: Entity or list of Entities</span>
<span class="sd">    config: Optional Configuration to use for this request, must be specified</span>
<span class="sd">      as a keyword argument.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Key or list of Keys</span>

<span class="sd">  Raises:</span>
<span class="sd">    TransactionFailedError, if the Put could not be committed.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">PutAsync</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">GetAsync</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously retrieves one or more entities from the datastore.</span>

<span class="sd">  Identical to datastore.Get() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call and get the results.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">extra_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;extra_hook&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">keys</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">NormalizeAndTypeCheckKeys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">local_extra_hook</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">multiple</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">entities</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">entities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">EntityNotFoundError</span><span class="p">()</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">entities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">extra_hook</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">extra_hook</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="k">return</span> <span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">async_get</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">local_extra_hook</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Get</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Retrieves one or more entities from the datastore.</span>

<span class="sd">  Retrieves the entity or entities with the given key(s) from the datastore</span>
<span class="sd">  and returns them as fully populated Entity objects, as defined below. If</span>
<span class="sd">  there is an error, raises a subclass of datastore_errors.Error.</span>

<span class="sd">  If keys is a single key or string, an Entity will be returned, or</span>
<span class="sd">  EntityNotFoundError will be raised if no existing entity matches the key.</span>

<span class="sd">  However, if keys is a list or tuple, a list of entities will be returned</span>
<span class="sd">  that corresponds to the sequence of keys. It will include entities for keys</span>
<span class="sd">  that were found and None placeholders for keys that were not found.</span>

<span class="sd">  Args:</span>
<span class="sd">    keys: Key or string or list of Keys or strings</span>
<span class="sd">    config: Optional Configuration to use for this request, must be specified</span>
<span class="sd">      as a keyword argument.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Entity or list of Entity objects</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">GetAsync</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">GetIndexesAsync</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously retrieves the application indexes and their states.</span>

<span class="sd">  Identical to GetIndexes() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call and get the results.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">extra_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;extra_hook&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">local_extra_hook</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">extra_hook</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">extra_hook</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="k">return</span> <span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">async_get_indexes</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">local_extra_hook</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">GetIndexes</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Retrieves the application indexes and their states.</span>

<span class="sd">  Args:</span>
<span class="sd">    config: Optional Configuration to use for this request, must be specified</span>
<span class="sd">      as a keyword argument.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list of (Index, Index.[BUILDING|SERVING|DELETING|ERROR]) tuples.</span>
<span class="sd">    An index can be in the following states:</span>
<span class="sd">      Index.BUILDING: Index is being built and therefore can not serve queries</span>
<span class="sd">      Index.SERVING: Index is ready to service queries</span>
<span class="sd">      Index.DELETING: Index is being deleted</span>
<span class="sd">      Index.ERROR: Index encounted an error in the BUILDING state</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">GetIndexesAsync</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">DeleteAsync</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously deletes one or more entities from the datastore.</span>

<span class="sd">  Identical to datastore.Delete() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&#39;read_policy&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">EVENTUAL_CONSISTENCY</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
        <span class="s">&#39;read_policy is only supported on read operations.&#39;</span><span class="p">)</span>
  <span class="n">keys</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">NormalizeAndTypeCheckKeys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">async_delete</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Delete</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Deletes one or more entities from the datastore. Use with care!</span>

<span class="sd">  Deletes the given entity(ies) from the datastore. You can only delete</span>
<span class="sd">  entities from your app. If there is an error, raises a subclass of</span>
<span class="sd">  datastore_errors.Error.</span>

<span class="sd">  Args:</span>
<span class="sd">    # the primary key(s) of the entity(ies) to delete</span>
<span class="sd">    keys: Key or string or list of Keys or strings</span>
<span class="sd">    config: Optional Configuration to use for this request, must be specified</span>
<span class="sd">      as a keyword argument.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TransactionFailedError, if the Delete could not be committed.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">DeleteAsync</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Entity</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A datastore entity.</span>

<span class="sd">  Includes read-only accessors for app id, kind, and primary key. Also</span>
<span class="sd">  provides dictionary-style access to properties.</span>
<span class="sd">  &quot;&quot;&quot;</span>


  <span class="n">__projection</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">unindexed_properties</span><span class="o">=</span><span class="p">[],</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor. Takes the kind and transaction root, which cannot be</span>
<span class="sd">    changed after the entity is constructed, and an optional parent. Raises</span>
<span class="sd">    BadArgumentError or BadKeyError if kind is invalid or parent is not an</span>
<span class="sd">    existing Entity or Key in the datastore.</span>

<span class="sd">    Args:</span>
<span class="sd">      # this entity&#39;s kind</span>
<span class="sd">      kind: string</span>
<span class="sd">      # if provided, this entity&#39;s parent. Its key must be complete.</span>
<span class="sd">      parent: Entity or Key</span>
<span class="sd">      # if provided, this entity&#39;s name.</span>
<span class="sd">      name: string</span>
<span class="sd">      # if provided, this entity&#39;s id.</span>
<span class="sd">      id: integer</span>
<span class="sd">      # if provided, a sequence of property names that should not be indexed</span>
<span class="sd">      # by the built-in single property indices.</span>
<span class="sd">      unindexed_properties: list or tuple of strings</span>
<span class="sd">      namespace: string</span>
<span class="sd">      # if provided, overrides the default namespace_manager setting.</span>
<span class="sd">    &quot;&quot;&quot;</span>





    <span class="n">ref</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Reference</span><span class="p">()</span>
    <span class="n">_app</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">ResolveAppId</span><span class="p">(</span><span class="n">_app</span><span class="p">)</span>
    <span class="n">ref</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">_app</span><span class="p">)</span>

    <span class="n">_namespace</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_namespace&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwds</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
          <span class="s">&#39;Excess keyword arguments &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kwds</span><span class="p">))</span>




    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">namespace</span> <span class="o">=</span> <span class="n">_namespace</span>
    <span class="k">elif</span> <span class="n">_namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&quot;Must not set both _namespace and namespace parameters.&quot;</span><span class="p">)</span>

    <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateString</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="s">&#39;kind&#39;</span><span class="p">,</span>
                                   <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">parent</span> <span class="o">=</span> <span class="n">_GetCompleteKeyOrError</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">_app</span> <span class="o">!=</span> <span class="n">parent</span><span class="o">.</span><span class="n">app</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&quot; </span><span class="si">%s</span><span class="s"> doesn&#39;t match parent&#39;s app </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">_app</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">app</span><span class="p">()))</span>


      <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span>
      <span class="k">elif</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="n">parent</span><span class="o">.</span><span class="n">namespace</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&quot; </span><span class="si">%s</span><span class="s"> doesn&#39;t match parent&#39;s namespace </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">namespace</span><span class="p">()))</span>
      <span class="n">ref</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_Key__reference</span><span class="p">)</span>

    <span class="n">namespace</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">ResolveNamespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
    <span class="n">datastore_types</span><span class="o">.</span><span class="n">SetNamespace</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

    <span class="n">last_path</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">mutable_path</span><span class="p">()</span><span class="o">.</span><span class="n">add_element</span><span class="p">()</span>
    <span class="n">last_path</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
          <span class="s">&quot;Cannot set both name and id on an Entity&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateString</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span>
      <span class="n">last_path</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateInteger</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">)</span>
      <span class="n">last_path</span><span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">set_unindexed_properties</span><span class="p">(</span><span class="n">unindexed_properties</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="n">_FromPb</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the name of the application that created this entity, a</span>
<span class="sd">    string or None if not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">app</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the namespace of this entity, a string or None.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns this entity&#39;s kind, a string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">is_saved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns if this entity has been saved to the datastore.&quot;&quot;&quot;</span>
    <span class="n">last_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">_Key__reference</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_list</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">last_path</span><span class="o">.</span><span class="n">has_name</span><span class="p">()</span> <span class="o">^</span> <span class="n">last_path</span><span class="o">.</span><span class="n">has_id</span><span class="p">())</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">is_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns if this entity is a projection from full entity.</span>

<span class="sd">    Projected entities:</span>
<span class="sd">    - may not contain all properties from the original entity;</span>
<span class="sd">    - only contain single values for lists;</span>
<span class="sd">    - may not contain values with the same type as the original entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__projection</span>

  <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns this entity&#39;s primary key, a Key instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span>

  <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns this entity&#39;s parent, as a Key. If this entity has no parent,</span>
<span class="sd">    returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">entity_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns this entity&#39;s entity group as a Key.</span>

<span class="sd">    Note that the returned Key will be incomplete if this is a a root entity</span>
<span class="sd">    and its key is incomplete.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">entity_group</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">unindexed_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns this entity&#39;s unindexed properties, as a frozenset of strings.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_Entity__unindexed_properties&#39;</span><span class="p">,</span> <span class="p">[])</span>

  <span class="k">def</span> <span class="nf">set_unindexed_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unindexed_properties</span><span class="p">):</span>

    <span class="n">unindexed_properties</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">NormalizeAndTypeCheck</span><span class="p">(</span><span class="n">unindexed_properties</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">multiple</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
        <span class="s">&#39;unindexed_properties must be a sequence; received </span><span class="si">%s</span><span class="s"> (a </span><span class="si">%s</span><span class="s">).&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">unindexed_properties</span><span class="p">,</span> <span class="n">typename</span><span class="p">(</span><span class="n">unindexed_properties</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">unindexed_properties</span><span class="p">:</span>
      <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateProperty</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__unindexed_properties</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">unindexed_properties</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the [] operator. Used to set property value(s).</span>

<span class="sd">    If the property name is the empty string or not a string, raises</span>
<span class="sd">    BadPropertyError. If the value is not a supported type, raises</span>
<span class="sd">    BadValueError.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If the property exists, returns its value. Otherwise sets it to value.</span>

<span class="sd">    If the property name is the empty string or not a string, raises</span>
<span class="sd">    BadPropertyError. If the value is not a supported type, raises</span>
<span class="sd">    BadValueError.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates this entity&#39;s properties from the values in other.</span>

<span class="sd">    If any property name is the empty string or not a string, raises</span>
<span class="sd">    BadPropertyError. If any value is not a supported type, raises</span>
<span class="sd">    BadValueError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The copy method is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Entity does not support the copy() method.&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">ToXml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an XML representation of this entity. Atom and gd:namespace</span>
<span class="sd">    properties are converted to XML according to their respective schemas. For</span>
<span class="sd">    more information, see:</span>

<span class="sd">      http://www.atomenabled.org/developers/syndication/</span>
<span class="sd">      http://code.google.com/apis/gdata/common-elements.html</span>

<span class="sd">    This is *not* optimized. It shouldn&#39;t be used anywhere near code that&#39;s</span>
<span class="sd">    performance-critical.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">xml</span> <span class="o">=</span> <span class="s">u&#39;&lt;entity kind=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">saxutils</span><span class="o">.</span><span class="n">quoteattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">():</span>
      <span class="n">xml</span> <span class="o">+=</span> <span class="s">&#39; key=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">saxutils</span><span class="o">.</span><span class="n">quoteattr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="p">))</span>
    <span class="n">xml</span> <span class="o">+=</span> <span class="s">&#39;&gt;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">():</span>
      <span class="n">xml</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  &lt;key&gt;</span><span class="si">%s</span><span class="s">&lt;/key&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">ToTagUri</span><span class="p">()</span>




    <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">properties</span><span class="p">:</span>
      <span class="n">properties</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="n">xml</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  &#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_PropertiesToXml</span><span class="p">(</span><span class="n">properties</span><span class="p">))</span>


    <span class="n">xml</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&lt;/entity&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">return</span> <span class="n">xml</span>

  <span class="k">def</span> <span class="nf">_PropertiesToXml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a list of the XML representations of each of the given</span>
<span class="sd">    properties. Ignores properties that don&#39;t exist in this entity.</span>

<span class="sd">    Arg:</span>
<span class="sd">      properties: string or list of strings</span>

<span class="sd">    Returns:</span>
<span class="sd">      list of strings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xml_properties</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">propname</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">propname</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="n">propname_xml</span> <span class="o">=</span> <span class="n">saxutils</span><span class="o">.</span><span class="n">quoteattr</span><span class="p">(</span><span class="n">propname</span><span class="p">)</span>

      <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">propname</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>

      <span class="n">proptype</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">PropertyTypeName</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">proptype_xml</span> <span class="o">=</span> <span class="n">saxutils</span><span class="o">.</span><span class="n">quoteattr</span><span class="p">(</span><span class="n">proptype</span><span class="p">)</span>

      <span class="n">escaped_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XmlEscapeValues</span><span class="p">(</span><span class="n">propname</span><span class="p">)</span>
      <span class="n">open_tag</span> <span class="o">=</span> <span class="s">u&#39;&lt;property name=</span><span class="si">%s</span><span class="s"> type=</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">propname_xml</span><span class="p">,</span> <span class="n">proptype_xml</span><span class="p">)</span>
      <span class="n">close_tag</span> <span class="o">=</span> <span class="s">u&#39;&lt;/property&gt;&#39;</span>
      <span class="n">xml_properties</span> <span class="o">+=</span> <span class="p">[</span><span class="n">open_tag</span> <span class="o">+</span> <span class="n">val</span> <span class="o">+</span> <span class="n">close_tag</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">escaped_values</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">xml_properties</span>

  <span class="k">def</span> <span class="nf">_XmlEscapeValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a list of the XML-escaped string values for the given property.</span>
<span class="sd">    Raises an AssertionError if the property doesn&#39;t exist.</span>

<span class="sd">    Arg:</span>
<span class="sd">      property: string</span>

<span class="sd">    Returns:</span>
<span class="sd">      list of strings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="nb">property</span><span class="p">)</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
      <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&#39;ToXml&#39;</span><span class="p">):</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">ToXml</span><span class="p">())</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">saxutils</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">xml</span>

  <span class="k">def</span> <span class="nf">ToPb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts this Entity to its protocol buffer representation.</span>

<span class="sd">    Returns:</span>
<span class="sd">      entity_pb.Entity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ToPb</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_ToPb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mark_key_as_saved</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts this Entity to its protocol buffer representation. Not</span>
<span class="sd">    intended to be used by application developers.</span>

<span class="sd">    Returns:</span>
<span class="sd">      entity_pb.Entity</span>
<span class="sd">    &quot;&quot;&quot;</span>





    <span class="n">pb</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">EntityProto</span><span class="p">()</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">mutable_key</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">_ToPb</span><span class="p">())</span>
    <span class="n">last_path</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_list</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mark_key_as_saved</span> <span class="ow">and</span> <span class="n">last_path</span><span class="o">.</span><span class="n">has_name</span><span class="p">()</span> <span class="ow">and</span> <span class="n">last_path</span><span class="o">.</span><span class="n">has_id</span><span class="p">():</span>
      <span class="n">last_path</span><span class="o">.</span><span class="n">clear_id</span><span class="p">()</span>


    <span class="n">group</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">mutable_entity_group</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">():</span>
      <span class="n">root</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">group</span><span class="o">.</span><span class="n">add_element</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>


    <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="n">properties</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
      <span class="n">properties</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">ToPropertyPb</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span><span class="n">properties</span><span class="p">]</span>

      <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">prop</span><span class="o">.</span><span class="n">has_meaning</span><span class="p">()</span> <span class="ow">and</span>
             <span class="n">prop</span><span class="o">.</span><span class="n">meaning</span><span class="p">()</span> <span class="ow">in</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_RAW_PROPERTY_MEANINGS</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unindexed_properties</span><span class="p">()):</span>
          <span class="n">pb</span><span class="o">.</span><span class="n">raw_property_list</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">pb</span><span class="o">.</span><span class="n">property_list</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">pb</span><span class="o">.</span><span class="n">property_size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_MAX_INDEXED_PROPERTIES</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
          <span class="s">&#39;Too many indexed properties for entity </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">pb</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">FromPb</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">validate_reserved_properties</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
             <span class="n">default_kind</span><span class="o">=</span><span class="s">&#39;&lt;not specified&gt;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Static factory method. Returns the Entity representation of the</span>
<span class="sd">    given protocol buffer (datastore_pb.Entity).</span>

<span class="sd">    Args:</span>
<span class="sd">      pb: datastore_pb.Entity or str encoding of a datastore_pb.Entity</span>
<span class="sd">      validate_reserved_properties: deprecated</span>
<span class="sd">      default_kind: str, the kind to use if the pb has no key.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Entity: the Entity representation of pb</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="n">real_pb</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">EntityProto</span><span class="p">()</span>
      <span class="n">real_pb</span><span class="o">.</span><span class="n">ParsePartialFromString</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
      <span class="n">pb</span> <span class="o">=</span> <span class="n">real_pb</span>

    <span class="k">return</span> <span class="n">Entity</span><span class="o">.</span><span class="n">_FromPb</span><span class="p">(</span>
        <span class="n">pb</span><span class="p">,</span> <span class="n">require_valid_key</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">default_kind</span><span class="o">=</span><span class="n">default_kind</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_FromPb</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">require_valid_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default_kind</span><span class="o">=</span><span class="s">&#39;&lt;not specified&gt;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Static factory method. Returns the Entity representation of the</span>
<span class="sd">    given protocol buffer (datastore_pb.Entity). Not intended to be used by</span>
<span class="sd">    application developers.</span>

<span class="sd">    The Entity PB&#39;s key must be complete. If it isn&#39;t, an AssertionError is</span>
<span class="sd">    raised.</span>

<span class="sd">    Args:</span>
<span class="sd">      # a protocol buffer Entity</span>
<span class="sd">      pb: datastore_pb.Entity</span>
<span class="sd">      default_kind: str, the kind to use if the pb has no key.</span>

<span class="sd">    Returns:</span>
<span class="sd">      # the Entity representation of the argument</span>
<span class="sd">      Entity</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_size</span><span class="p">():</span>
      <span class="n">pb</span><span class="o">.</span><span class="n">mutable_key</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">default_kind</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">_ToPb</span><span class="p">())</span>

    <span class="n">last_path</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_list</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">require_valid_key</span><span class="p">:</span>
      <span class="k">assert</span> <span class="n">last_path</span><span class="o">.</span><span class="n">has_id</span><span class="p">()</span> <span class="o">^</span> <span class="n">last_path</span><span class="o">.</span><span class="n">has_name</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">last_path</span><span class="o">.</span><span class="n">has_id</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">last_path</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">last_path</span><span class="o">.</span><span class="n">has_name</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">last_path</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>


    <span class="n">unindexed_properties</span> <span class="o">=</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pb</span><span class="o">.</span><span class="n">raw_property_list</span><span class="p">()]</span>


    <span class="k">if</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">has_name_space</span><span class="p">():</span>
      <span class="n">namespace</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name_space</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">last_path</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="s">&#39;utf-8&#39;</span><span class="p">),</span>
               <span class="n">unindexed_properties</span><span class="o">=</span><span class="n">unindexed_properties</span><span class="p">,</span>
               <span class="n">_app</span><span class="o">=</span><span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">app</span><span class="p">(),</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">__key</span><span class="o">.</span><span class="n">_Key__reference</span>
    <span class="n">ref</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>



    <span class="n">temporary_values</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">prop_list</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">property_list</span><span class="p">(),</span> <span class="n">pb</span><span class="o">.</span><span class="n">raw_property_list</span><span class="p">()):</span>
      <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">prop_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">meaning</span><span class="p">()</span> <span class="o">==</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">INDEX_VALUE</span><span class="p">:</span>
          <span class="n">e</span><span class="o">.</span><span class="n">__projection</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">FromPropertyPb</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span>
            <span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> is corrupt in the datastore:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>

        <span class="n">multiple</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">multiple</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">multiple</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="n">cur_value</span> <span class="o">=</span> <span class="n">temporary_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">temporary_values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">multiple</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
          <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span>
            <span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> is corrupt in the datastore; it has multiple &#39;</span>
            <span class="s">&#39;values, but is not marked as multiply valued.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">cur_value</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>



    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">temporary_values</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="n">decoded_name</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>




      <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateReadProperty</span><span class="p">(</span><span class="n">decoded_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

      <span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">decoded_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">e</span>


<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A datastore query.</span>

<span class="sd">  (Instead of this, consider using appengine.ext.gql.Query! It provides a</span>
<span class="sd">  query language interface on top of the same functionality.)</span>

<span class="sd">  Queries are used to retrieve entities that match certain criteria, including</span>
<span class="sd">  app id, kind, and property filters. Results may also be sorted by properties.</span>

<span class="sd">  App id and kind are required. Only entities from the given app, of the given</span>
<span class="sd">  type, are returned. If an ancestor is set, with Ancestor(), only entities</span>
<span class="sd">  with that ancestor are returned.</span>

<span class="sd">  Property filters are used to provide criteria based on individual property</span>
<span class="sd">  values. A filter compares a specific property in each entity to a given</span>
<span class="sd">  value or list of possible values.</span>

<span class="sd">  An entity is returned if its property values match *all* of the query&#39;s</span>
<span class="sd">  filters. In other words, filters are combined with AND, not OR. If an</span>
<span class="sd">  entity does not have a value for a property used in a filter, it is not</span>
<span class="sd">  returned.</span>

<span class="sd">  Property filters map filter strings of the form &#39;&lt;property name&gt; &lt;operator&gt;&#39;</span>
<span class="sd">  to filter values. Use dictionary accessors to set property filters, like so:</span>

<span class="sd">  &gt; query = Query(&#39;Person&#39;)</span>
<span class="sd">  &gt; query[&#39;name =&#39;] = &#39;Ryan&#39;</span>
<span class="sd">  &gt; query[&#39;age &gt;=&#39;] = 21</span>

<span class="sd">  This query returns all Person entities where the name property is &#39;Ryan&#39;,</span>
<span class="sd">  &#39;Ken&#39;, or &#39;Bret&#39;, and the age property is at least 21.</span>

<span class="sd">  Another way to build this query is:</span>

<span class="sd">  &gt; query = Query(&#39;Person&#39;)</span>
<span class="sd">  &gt; query.update({&#39;name =&#39;: &#39;Ryan&#39;, &#39;age &gt;=&#39;: 21})</span>

<span class="sd">  The supported operators are =, &gt;, &lt;, &gt;=, and &lt;=. Only one inequality</span>
<span class="sd">  filter may be used per query. Any number of equals filters may be used in</span>
<span class="sd">  a single Query.</span>

<span class="sd">  A filter value may be a list or tuple of values. This is interpreted as</span>
<span class="sd">  multiple filters with the same filter string and different values, all ANDed</span>
<span class="sd">  together. For example, this query returns everyone with the tags &quot;google&quot;</span>
<span class="sd">  and &quot;app engine&quot;:</span>

<span class="sd">  &gt; Query(&#39;Person&#39;, {&#39;tag =&#39;: (&#39;google&#39;, &#39;app engine&#39;)})</span>

<span class="sd">  Result entities can be returned in different orders. Use the Order()</span>
<span class="sd">  method to specify properties that results will be sorted by, and in which</span>
<span class="sd">  direction.</span>

<span class="sd">  Note that filters and orderings may be provided at any time before the query</span>
<span class="sd">  is run. When the query is fully specified, Run() runs the query and returns</span>
<span class="sd">  an iterator. The query results can be accessed through the iterator.</span>

<span class="sd">  A query object may be reused after it&#39;s been run. Its filters and</span>
<span class="sd">  orderings can be changed to create a modified query.</span>

<span class="sd">  If you know how many result entities you need, use Get() to fetch them:</span>

<span class="sd">  &gt; query = Query(&#39;Person&#39;, {&#39;age &gt;&#39;: 21})</span>
<span class="sd">  &gt; for person in query.Get(4):</span>
<span class="sd">  &gt;   print &#39;I have four pints left. Have one on me, %s!&#39; % person[&#39;name&#39;]</span>

<span class="sd">  If you don&#39;t know how many results you need, or if you need them all, you</span>
<span class="sd">  can get an iterator over the results by calling Run():</span>

<span class="sd">  &gt; for person in Query(&#39;Person&#39;, {&#39;age &gt;&#39;: 21}).Run():</span>
<span class="sd">  &gt;   print &#39;Have a pint on me, %s!&#39; % person[&#39;name&#39;]</span>

<span class="sd">  Get() is more efficient than Run(), so use Get() whenever possible.</span>

<span class="sd">  Finally, the Count() method returns the number of result entities matched by</span>
<span class="sd">  the query. The returned count is cached; successive Count() calls will not</span>
<span class="sd">  re-scan the datastore unless the query is changed.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">ASCENDING</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="o">.</span><span class="n">ASCENDING</span>
  <span class="n">DESCENDING</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="o">.</span><span class="n">DESCENDING</span>


  <span class="n">ORDER_FIRST</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="o">.</span><span class="n">ORDER_FIRST</span>
  <span class="n">ANCESTOR_FIRST</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="o">.</span><span class="n">ANCESTOR_FIRST</span>
  <span class="n">FILTER_FIRST</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="o">.</span><span class="n">FILTER_FIRST</span>


  <span class="n">OPERATORS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;==&#39;</span><span class="p">:</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyFilter</span><span class="o">.</span><span class="n">_OPERATORS</span><span class="p">[</span><span class="s">&#39;=&#39;</span><span class="p">]}</span>
  <span class="n">OPERATORS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyFilter</span><span class="o">.</span><span class="n">_OPERATORS</span><span class="p">)</span>

  <span class="n">INEQUALITY_OPERATORS</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyFilter</span><span class="o">.</span><span class="n">_INEQUALITY_OPERATORS</span>

  <span class="n">UPPERBOUND_INEQUALITY_OPERATORS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;=&#39;</span><span class="p">])</span>
  <span class="n">FILTER_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s">&#39;^\s*([^\s]+)(\s+(</span><span class="si">%s</span><span class="s">)\s*)?$&#39;</span> <span class="o">%</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OPERATORS</span><span class="p">),</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

  <span class="n">__kind</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__app</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__namespace</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__orderings</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__ancestor_pb</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__distinct</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">__group_by</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">__index_list_source</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__cursor_source</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__compiled_query_source</span> <span class="o">=</span> <span class="bp">None</span>




  <span class="n">__filter_order</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__filter_counter</span> <span class="o">=</span> <span class="mi">0</span>


  <span class="n">__inequality_prop</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__inequality_count</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{},</span> <span class="n">_app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keys_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="nb">compile</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end_cursor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">projection</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Raises BadArgumentError if kind is not a string. Raises BadValueError or</span>
<span class="sd">    BadFilterError if filters is not a dictionary of valid filters.</span>

<span class="sd">    Args:</span>
<span class="sd">      namespace: string, the namespace to query.</span>
<span class="sd">      kind: string, the kind of entities to query, or None.</span>
<span class="sd">      filters: dict, initial set of filters.</span>
<span class="sd">      keys_only: boolean, if keys should be returned instead of entities.</span>
<span class="sd">      projection: iterable of property names to project.</span>
<span class="sd">      distinct: boolean, if projection should be distinct.</span>
<span class="sd">      compile: boolean, if the query should generate cursors.</span>
<span class="sd">      cursor: datastore_query.Cursor, the start cursor to use.</span>
<span class="sd">      end_cursor: datastore_query.Cursor, the end cursor to use.</span>
<span class="sd">      _namespace: deprecated, use namespace instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>








    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">namespace</span> <span class="o">=</span> <span class="n">_namespace</span>
    <span class="k">elif</span> <span class="n">_namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&quot;Must not set both _namespace and namespace parameters.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateString</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="s">&#39;kind&#39;</span><span class="p">,</span>
                                     <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__filter_order</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__app</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">ResolveAppId</span><span class="p">(</span><span class="n">_app</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__namespace</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">ResolveNamespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">__query_options</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">(</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="n">keys_only</span><span class="p">,</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="nb">compile</span><span class="p">,</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="n">end_cursor</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distinct</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_options</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadQueryError</span><span class="p">(</span>
            <span class="s">&#39;cannot specify distinct without a projection&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__distinct</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__group_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_options</span><span class="o">.</span><span class="n">projection</span>

  <span class="k">def</span> <span class="nf">Order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">orderings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Specify how the query results should be sorted.</span>

<span class="sd">    Result entities will be sorted by the first property argument, then by the</span>
<span class="sd">    second, and so on. For example, this:</span>

<span class="sd">    &gt; query = Query(&#39;Person&#39;)</span>
<span class="sd">    &gt; query.Order(&#39;bday&#39;, (&#39;age&#39;, Query.DESCENDING))</span>

<span class="sd">    sorts everyone in order of their birthday, starting with January 1.</span>
<span class="sd">    People with the same birthday are sorted by age, oldest to youngest.</span>

<span class="sd">    The direction for each sort property may be provided; if omitted, it</span>
<span class="sd">    defaults to ascending.</span>

<span class="sd">    Order() may be called multiple times. Each call resets the sort order</span>
<span class="sd">    from scratch.</span>

<span class="sd">    If an inequality filter exists in this Query it must be the first property</span>
<span class="sd">    passed to Order. Any number of sort orders may be used after the</span>
<span class="sd">    inequality filter property. Without inequality filters, any number of</span>
<span class="sd">    filters with different orders may be specified.</span>

<span class="sd">    Entities with multiple values for an order property are sorted by their</span>
<span class="sd">    lowest value.</span>

<span class="sd">    Note that a sort order implies an existence filter! In other words,</span>
<span class="sd">    Entities without the sort order property are filtered out, and *not*</span>
<span class="sd">    included in the query results.</span>

<span class="sd">    If the sort order property has different types in different entities - ie,</span>
<span class="sd">    if bob[&#39;id&#39;] is an int and fred[&#39;id&#39;] is a string - the entities will be</span>
<span class="sd">    grouped first by the property type, then sorted within type. No attempt is</span>
<span class="sd">    made to compare property values across types.</span>

<span class="sd">    Raises BadArgumentError if any argument is of the wrong format.</span>

<span class="sd">    Args:</span>
<span class="sd">      # the properties to sort by, in sort order. each argument may be either a</span>
<span class="sd">      # string or (string, direction) 2-tuple.</span>

<span class="sd">    Returns:</span>
<span class="sd">      # this query</span>
<span class="sd">      Query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orderings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">orderings</span><span class="p">)</span>


    <span class="k">for</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">orderings</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orderings</span><span class="p">))):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span>
              <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])):</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
          <span class="s">&#39;Order() expects strings or 2- or 3-tuples; received </span><span class="si">%s</span><span class="s"> (a </span><span class="si">%s</span><span class="s">). &#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">typename</span><span class="p">(</span><span class="n">order</span><span class="p">)))</span>


      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span><span class="p">,)</span>

      <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateString</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;sort order property&#39;</span><span class="p">,</span>
                                     <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">)</span>
      <span class="nb">property</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


      <span class="n">direction</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Query</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">,</span> <span class="n">Query</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&#39;Order() expects Query.ASCENDING or DESCENDING; received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">ASCENDING</span>

      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kind</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
          <span class="p">(</span><span class="nb">property</span> <span class="o">!=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span> <span class="ow">or</span>
          <span class="n">direction</span> <span class="o">!=</span> <span class="n">Query</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&#39;Only </span><span class="si">%s</span><span class="s"> ascending orders are supported on kindless queries&#39;</span> <span class="o">%</span>
            <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span><span class="p">)</span>

      <span class="n">orderings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">orderings</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span> <span class="ow">and</span>
        <span class="n">orderings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
        <span class="s">&#39;First ordering property must be the same as inequality filter &#39;</span>
        <span class="s">&#39;property, if specified for this query; received </span><span class="si">%s</span><span class="s">, expected </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">orderings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span> <span class="o">=</span> <span class="n">orderings</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">Hint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets a hint for how this query should run.</span>

<span class="sd">    The query hint gives us information about how best to execute your query.</span>
<span class="sd">    Currently, we can only do one index scan, so the query hint should be used</span>
<span class="sd">    to indicates which index we should scan against.</span>

<span class="sd">    Use FILTER_FIRST if your first filter will only match a few results. In</span>
<span class="sd">    this case, it will be most efficient to scan against the index for this</span>
<span class="sd">    property, load the results into memory, and apply the remaining filters</span>
<span class="sd">    and sort orders there.</span>

<span class="sd">    Similarly, use ANCESTOR_FIRST if the query&#39;s ancestor only has a few</span>
<span class="sd">    descendants. In this case, it will be most efficient to scan all entities</span>
<span class="sd">    below the ancestor and load them into memory first.</span>

<span class="sd">    Use ORDER_FIRST if the query has a sort order and the result set is large</span>
<span class="sd">    or you only plan to fetch the first few results. In that case, we</span>
<span class="sd">    shouldn&#39;t try to load all of the results into memory; instead, we should</span>
<span class="sd">    scan the index for this property, which is in sorted order.</span>

<span class="sd">    Note that hints are currently ignored in the v3 datastore!</span>

<span class="sd">    Arg:</span>
<span class="sd">      one of datastore.Query.[ORDER_FIRST, ANCESTOR_FIRST, FILTER_FIRST]</span>

<span class="sd">    Returns:</span>
<span class="sd">      # this query</span>
<span class="sd">      Query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_options</span><span class="o">.</span><span class="n">hint</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__query_options</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">(</span>
          <span class="n">hint</span><span class="o">=</span><span class="n">hint</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__query_options</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">Ancestor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets an ancestor for this query.</span>

<span class="sd">    This restricts the query to only return result entities that are descended</span>
<span class="sd">    from a given entity. In other words, all of the results will have the</span>
<span class="sd">    ancestor as their parent, or parent&#39;s parent, or etc.</span>

<span class="sd">    Raises BadArgumentError or BadKeyError if parent is not an existing Entity</span>
<span class="sd">    or Key in the datastore.</span>

<span class="sd">    Args:</span>
<span class="sd">      # the key must be complete</span>
<span class="sd">      ancestor: Entity or Key</span>

<span class="sd">    Returns:</span>
<span class="sd">      # this query</span>
<span class="sd">      Query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__ancestor_pb</span> <span class="o">=</span> <span class="n">_GetCompleteKeyOrError</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span><span class="o">.</span><span class="n">_ToPb</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">IsKeysOnly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if this query is keys only, false otherwise.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_options</span><span class="o">.</span><span class="n">keys_only</span>

  <span class="k">def</span> <span class="nf">GetQueryOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a datastore_query.QueryOptions for the current instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_options</span>

  <span class="k">def</span> <span class="nf">GetQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a datastore_query.Query for the current instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">Query</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__app</span><span class="p">,</span>
                                 <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__namespace</span><span class="p">,</span>
                                 <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kind</span><span class="p">,</span>
                                 <span class="n">ancestor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__ancestor_pb</span><span class="p">,</span>
                                 <span class="n">filter_predicate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GetFilterPredicate</span><span class="p">(),</span>
                                 <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GetOrder</span><span class="p">(),</span>
                                 <span class="n">group_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__group_by</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">GetOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets a datastore_query.Order for the current instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">      datastore_query.Order or None if there are no sort orders set on the</span>
<span class="sd">      current Query.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">orders</span> <span class="o">=</span> <span class="p">[</span><span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
              <span class="k">for</span> <span class="nb">property</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">orders</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">CompositeOrder</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">GetFilterPredicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a datastore_query.FilterPredicate for the current instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">      datastore_query.FilterPredicate or None if no filters are set on the</span>
<span class="sd">      current Query.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ordered_filters</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_order</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
    <span class="n">ordered_filters</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">property_filters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">filter_str</span> <span class="ow">in</span> <span class="n">ordered_filters</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">filter_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>

        <span class="k">continue</span>

      <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">filter_str</span><span class="p">]</span>
      <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CheckFilter</span><span class="p">(</span><span class="n">filter_str</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

      <span class="n">op</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;==&#39;</span><span class="p">:</span>

        <span class="n">op</span> <span class="o">=</span> <span class="s">&#39;=&#39;</span>

      <span class="n">property_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datastore_query</span><span class="o">.</span><span class="n">make_filter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">property_filters</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">CompositeFilter</span><span class="p">(</span>
          <span class="n">datastore_query</span><span class="o">.</span><span class="n">CompositeFilter</span><span class="o">.</span><span class="n">AND</span><span class="p">,</span>
          <span class="n">property_filters</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">GetDistinct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if the current instance is distinct.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A boolean indicating if the distinct flag is set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__distinct</span>

  <span class="k">def</span> <span class="nf">GetIndexList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the index list from the last run of this query.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A list of indexes used by the last run of this query.</span>

<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: The query has not yet been run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index_list_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__index_list_source</span>
    <span class="k">if</span> <span class="n">index_list_function</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">index_list_function</span><span class="p">()</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;No index list available because this query has not &#39;</span>
                         <span class="s">&#39;been executed&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">GetCursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the cursor from the last run of this query.</span>

<span class="sd">    The source of this cursor varies depending on what the last call was:</span>
<span class="sd">      - Run: A cursor that points immediately after the last result pulled off</span>
<span class="sd">        the returned iterator.</span>
<span class="sd">      - Get: A cursor that points immediately after the last result in the</span>
<span class="sd">        returned list.</span>
<span class="sd">      - Count: A cursor that points immediately after the last result counted.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A datastore_query.Cursor object that can be used in subsequent query</span>
<span class="sd">      requests.</span>

<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: The query has not yet been run or cannot be compiled.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">cursor_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cursor_source</span>
    <span class="k">if</span> <span class="n">cursor_function</span><span class="p">:</span>
      <span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor_function</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cursor</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;No cursor available, either this query has not &#39;</span>
                         <span class="s">&#39;been executed or there is no compilation &#39;</span>
                         <span class="s">&#39;available for this kind of query&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">GetBatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs this query and returns a datastore_query.Batcher.</span>

<span class="sd">    This is not intended to be used by application developers. Use Get()</span>
<span class="sd">    instead!</span>

<span class="sd">    Args:</span>
<span class="sd">      config: Optional Configuration to use for this request.</span>

<span class="sd">    Returns:</span>
<span class="sd">      # an iterator that provides access to the query results</span>
<span class="sd">      Iterator</span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="n">query_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetQueryOptions</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__distinct</span> <span class="ow">and</span> <span class="n">query_options</span><span class="o">.</span><span class="n">projection</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__group_by</span><span class="p">:</span>




      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
          <span class="s">&#39;cannot override projection when distinct is set&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetQuery</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">_GetConnection</span><span class="p">(),</span> <span class="n">query_options</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">Run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs this query.</span>

<span class="sd">    If a filter string is invalid, raises BadFilterError. If a filter value is</span>
<span class="sd">    invalid, raises BadValueError. If an IN filter is provided, and a sort</span>
<span class="sd">    order on another property is provided, raises BadQueryError.</span>

<span class="sd">    If you know in advance how many results you want, use limit=#. It&#39;s</span>
<span class="sd">    more efficient.</span>

<span class="sd">    Args:</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      # an iterator that provides access to the query results</span>
<span class="sd">      Iterator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">convert_rpc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="n">config_class</span><span class="o">=</span><span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">)</span>
    <span class="n">itr</span> <span class="o">=</span> <span class="n">Iterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetBatcher</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__index_list_source</span> <span class="o">=</span> <span class="n">itr</span><span class="o">.</span><span class="n">GetIndexList</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__cursor_source</span> <span class="o">=</span> <span class="n">itr</span><span class="o">.</span><span class="n">cursor</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__compiled_query_source</span> <span class="o">=</span> <span class="n">itr</span><span class="o">.</span><span class="n">_compiled_query</span>
    <span class="k">return</span> <span class="n">itr</span>

  <span class="k">def</span> <span class="nf">Get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deprecated, use list(Run(...)) instead.</span>

<span class="sd">    Args:</span>
<span class="sd">      limit: int or long representing the maximum number of entities to return.</span>
<span class="sd">      offset: int or long representing the number of entities to skip</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      # a list of entities</span>
<span class="sd">      [Entity, ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;batch_size&#39;</span><span class="p">,</span> <span class="n">_MAX_INT_32</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">Count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the number of entities that this query matches.</span>

<span class="sd">    Args:</span>
<span class="sd">      limit, a number or None. If there are more results than this, stop short</span>
<span class="sd">      and just return this number. Providing this argument makes the count</span>
<span class="sd">      operation more efficient.</span>
<span class="sd">      config: Optional Configuration to use for this request.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The number of results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;offset&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">offset</span> <span class="o">=</span> <span class="n">_MAX_INT_32</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">offset</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limit</span> <span class="o">+</span> <span class="n">original_offset</span><span class="p">,</span> <span class="n">_MAX_INT_32</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">convert_rpc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="n">config_class</span><span class="o">=</span><span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">)</span>

    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetBatcher</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__index_list_source</span> <span class="o">=</span> <span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">index_list</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__cursor_source</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">batch</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__compiled_query_source</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">batch</span><span class="o">.</span><span class="n">_compiled_query</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">skipped_results</span> <span class="o">-</span> <span class="n">original_offset</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
      <span class="s">&#39;Query objects should not be used as iterators. Call Run() first.&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">state</span><span class="p">[</span><span class="s">&#39;_Query__index_list_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">state</span><span class="p">[</span><span class="s">&#39;_Query__cursor_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">state</span><span class="p">[</span><span class="s">&#39;_Query__compiled_query_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">state</span>

  <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>

    <span class="k">if</span> <span class="s">&#39;_Query__query_options&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
      <span class="n">state</span><span class="p">[</span><span class="s">&#39;_Query__query_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">(</span>
        <span class="n">keys_only</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_Query__keys_only&#39;</span><span class="p">),</span>
        <span class="n">produce_cursors</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_Query__compile&#39;</span><span class="p">),</span>
        <span class="n">start_cursor</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_Query__cursor&#39;</span><span class="p">),</span>
        <span class="n">end_cursor</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_Query__end_cursor&#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="n">state</span>

  <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the [] operator. Used to set filters.</span>

<span class="sd">    If the filter string is empty or not a string, raises BadFilterError. If</span>
<span class="sd">    the value is not a supported type, raises BadValueError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateProperty</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CheckFilter</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="nb">property</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">operator</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INEQUALITY_OPERATORS</span> <span class="ow">and</span>
        <span class="nb">property</span> <span class="o">!=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_UNAPPLIED_LOG_TIMESTAMP_SPECIAL_PROPERTY</span><span class="p">):</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span> <span class="o">=</span> <span class="nb">property</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span> <span class="o">==</span> <span class="nb">property</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_count</span> <span class="o">+=</span> <span class="mi">1</span>


    <span class="k">if</span> <span class="nb">filter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_order</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__filter_order</span><span class="p">[</span><span class="nb">filter</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_counter</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__filter_counter</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If the filter exists, returns its value. Otherwise sets it to value.</span>

<span class="sd">    If the property name is the empty string or not a string, raises</span>
<span class="sd">    BadPropertyError. If the value is not a supported type, raises</span>
<span class="sd">    BadValueError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datastore_types</span><span class="o">.</span><span class="n">ValidateProperty</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_CheckFilter</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the del [] operator. Used to remove filters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">dict</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_order</span><span class="p">[</span><span class="nb">filter</span><span class="p">]</span>


    <span class="n">match</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">FILTER_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
    <span class="nb">property</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">operator</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INEQUALITY_OPERATORS</span><span class="p">:</span>
      <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_count</span> <span class="o">&gt;=</span> <span class="mi">1</span>
      <span class="k">assert</span> <span class="nb">property</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_count</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates this query&#39;s filters from the ones in other.</span>

<span class="sd">    If any filter string is invalid, raises BadFilterError. If any value is</span>
<span class="sd">    not a supported type, raises BadValueError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The copy method is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Query does not support the copy() method.&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_CheckFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Type check a filter string and list of values.</span>

<span class="sd">    Raises BadFilterError if the filter string is empty, not a string, or</span>
<span class="sd">    invalid. Raises BadValueError if the value type is not supported.</span>

<span class="sd">    Args:</span>
<span class="sd">      filter: String containing the filter text.</span>
<span class="sd">      values: List of associated filter values.</span>

<span class="sd">    Returns:</span>
<span class="sd">      re.MatchObject (never None) that matches the &#39;filter&#39;. Group 1 is the</span>
<span class="sd">      property name, group 3 is the operator. (Group 2 is unused.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">match</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">FILTER_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
          <span class="s">&#39;Could not parse filter string: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">filter</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
        <span class="s">&#39;Could not parse filter string: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">filter</span><span class="p">))</span>

    <span class="nb">property</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">operator</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">operator</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">operator</span> <span class="o">=</span> <span class="s">&#39;=&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
      <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_RAW_PROPERTY_TYPES</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
        <span class="s">&#39;Filtering on </span><span class="si">%s</span><span class="s"> properties is not supported.&#39;</span> <span class="o">%</span> <span class="n">typename</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INEQUALITY_OPERATORS</span> <span class="ow">and</span>
        <span class="nb">property</span> <span class="o">!=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_UNAPPLIED_LOG_TIMESTAMP_SPECIAL_PROPERTY</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span> <span class="ow">and</span> <span class="nb">property</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inequality_prop</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
            <span class="s">&#39;Only one property per query may have inequality filters (</span><span class="si">%s</span><span class="s">).&#39;</span> <span class="o">%</span>
            <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INEQUALITY_OPERATORS</span><span class="p">))</span>
      <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">property</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
            <span class="s">&#39;Inequality operators (</span><span class="si">%s</span><span class="s">) must be on the same property as the &#39;</span>
            <span class="s">&#39;first sort order, if any sort orders are supplied&#39;</span> <span class="o">%</span>
            <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INEQUALITY_OPERATORS</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kind</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
        <span class="nb">property</span> <span class="o">!=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span> <span class="ow">and</span>
        <span class="nb">property</span> <span class="o">!=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_UNAPPLIED_LOG_TIMESTAMP_SPECIAL_PROPERTY</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
          <span class="s">&#39;Only </span><span class="si">%s</span><span class="s"> filters are allowed on kindless queries.&#39;</span> <span class="o">%</span>
          <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">property</span> <span class="o">==</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_UNAPPLIED_LOG_TIMESTAMP_SPECIAL_PROPERTY</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kind</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
            <span class="s">&#39;Only kindless queries can have </span><span class="si">%s</span><span class="s"> filters.&#39;</span> <span class="o">%</span>
            <span class="n">datastore_types</span><span class="o">.</span><span class="n">_UNAPPLIED_LOG_TIMESTAMP_SPECIAL_PROPERTY</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPPERBOUND_INEQUALITY_OPERATORS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
            <span class="s">&#39;Only </span><span class="si">%s</span><span class="s"> operators are supported with </span><span class="si">%s</span><span class="s"> filters.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UPPERBOUND_INEQUALITY_OPERATORS</span><span class="p">,</span>
            <span class="n">datastore_types</span><span class="o">.</span><span class="n">_UNAPPLIED_LOG_TIMESTAMP_SPECIAL_PROPERTY</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">property</span> <span class="ow">in</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_SPECIAL_PROPERTIES</span><span class="p">:</span>




      <span class="k">if</span> <span class="nb">property</span> <span class="o">==</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
              <span class="s">&#39;</span><span class="si">%s</span><span class="s"> filter value must be a Key; received </span><span class="si">%s</span><span class="s"> (a </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">typename</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">match</span>

  <span class="k">def</span> <span class="nf">_Run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
           <span class="n">prefetch_count</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">next_count</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deprecated, use Run() instead.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
                    <span class="n">prefetch_size</span><span class="o">=</span><span class="n">prefetch_count</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">next_count</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_ToPb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">query_options</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GetQueryOptions</span><span class="p">(),</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetQuery</span><span class="p">()</span><span class="o">.</span><span class="n">_to_pb</span><span class="p">(</span><span class="n">_GetConnection</span><span class="p">(),</span> <span class="n">query_options</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetCompiledQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the internal-only pb representation of the last query run.</span>

<span class="sd">    Do not use.</span>

<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: Query not compiled or not yet executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">compiled_query_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compiled_query_source</span>
    <span class="k">if</span> <span class="n">compiled_query_function</span><span class="p">:</span>
      <span class="n">compiled_query</span> <span class="o">=</span> <span class="n">compiled_query_function</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">compiled_query</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compiled_query</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;No compiled query available, either this query has &#39;</span>
                         <span class="s">&#39;not been executed or there is no compilation &#39;</span>
                         <span class="s">&#39;available for this kind of query&#39;</span><span class="p">)</span>

  <span class="n">GetCompiledQuery</span> <span class="o">=</span> <span class="n">_GetCompiledQuery</span>
  <span class="n">GetCompiledCursor</span> <span class="o">=</span> <span class="n">GetCursor</span>


<span class="k">def</span> <span class="nf">AllocateIdsAsync</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously allocates a range of IDs.</span>

<span class="sd">  Identical to datastore.AllocateIds() except returns an asynchronous object.</span>
<span class="sd">  Call get_result() on the return value to block on the call and get the</span>
<span class="sd">  results.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="nb">max</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;max&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&#39;read_policy&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">EVENTUAL_CONSISTENCY</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
        <span class="s">&#39;read_policy is only supported on read operations.&#39;</span><span class="p">)</span>
  <span class="n">keys</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">NormalizeAndTypeCheckKeys</span><span class="p">(</span><span class="n">model_key</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
        <span class="s">&#39;Cannot allocate IDs for more than one model key at a time&#39;</span><span class="p">)</span>

  <span class="n">rpc</span> <span class="o">=</span> <span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">async_allocate_ids</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">rpc</span>


<span class="k">def</span> <span class="nf">AllocateIds</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Allocates a range of IDs of size or with max for the given key.</span>

<span class="sd">  Allocates a range of IDs in the datastore such that those IDs will not</span>
<span class="sd">  be automatically assigned to new entities. You can only allocate IDs</span>
<span class="sd">  for model keys from your app. If there is an error, raises a subclass of</span>
<span class="sd">  datastore_errors.Error.</span>

<span class="sd">  Either size or max must be provided but not both. If size is provided then a</span>
<span class="sd">  range of the given size is returned. If max is provided then the largest</span>
<span class="sd">  range of ids that are safe to use with an upper bound of max is returned (can</span>
<span class="sd">  be an empty range).</span>

<span class="sd">  Max should only be provided if you have an existing numeric id range that you</span>
<span class="sd">  want to reserve, e.g. bulk loading entities that already have IDs. If you</span>
<span class="sd">  don&#39;t care about which IDs you receive, use size instead.</span>

<span class="sd">  Args:</span>
<span class="sd">    model_key: Key or string to serve as a model specifying the ID sequence</span>
<span class="sd">               in which to allocate IDs</span>
<span class="sd">    size: integer, number of IDs to allocate.</span>
<span class="sd">    max: integer, upper bound of the range of IDs to allocate.</span>
<span class="sd">    config: Optional Configuration to use for this request.</span>

<span class="sd">  Returns:</span>
<span class="sd">    (start, end) of the allocated range, inclusive.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">AllocateIdsAsync</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>




<span class="k">class</span> <span class="nc">MultiQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class representing a query which requires multiple datastore queries.</span>

<span class="sd">  This class is actually a subclass of datastore.Query as it is intended to act</span>
<span class="sd">  like a normal Query object (supporting the same interface).</span>

<span class="sd">  Does not support keys only queries, since it needs whole entities in order</span>
<span class="sd">  to merge sort them. (That&#39;s not true if there are no sort orders, or if the</span>
<span class="sd">  sort order is on __key__, but allowing keys only queries in those cases, but</span>
<span class="sd">  not in others, would be confusing.)</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bound_queries</span><span class="p">,</span> <span class="n">orderings</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bound_queries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_ALLOWABLE_QUERIES</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
          <span class="s">&#39;Cannot satisfy query -- too many subqueries (max: </span><span class="si">%d</span><span class="s">, got </span><span class="si">%d</span><span class="s">).&#39;</span>
          <span class="s">&#39; Probable cause: too many IN/!= filters in query.&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">MAX_ALLOWABLE_QUERIES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bound_queries</span><span class="p">)))</span>

    <span class="n">projection</span> <span class="o">=</span> <span class="p">(</span><span class="n">bound_queries</span> <span class="ow">and</span>
                  <span class="n">bound_queries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetQueryOptions</span><span class="p">()</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">bound_queries</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">projection</span> <span class="o">!=</span> <span class="n">query</span><span class="o">.</span><span class="n">GetQueryOptions</span><span class="p">()</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadQueryError</span><span class="p">(</span>
            <span class="s">&#39;All queries must have the same projection.&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">IsKeysOnly</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadQueryError</span><span class="p">(</span>
            <span class="s">&#39;MultiQuery does not support keys_only.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__projection</span> <span class="o">=</span> <span class="n">projection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span> <span class="o">=</span> <span class="n">bound_queries</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span> <span class="o">=</span> <span class="n">orderings</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__compile</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s">&#39;MultiQuery: &#39;</span>
    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">:</span>
      <span class="n">res</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span>

  <span class="k">def</span> <span class="nf">Get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deprecated, use list(Run(...)) instead.</span>

<span class="sd">    Args:</span>
<span class="sd">      limit: int or long representing the maximum number of entities to return.</span>
<span class="sd">      offset: int or long representing the number of entities to skip</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      A list of entities with at most &quot;limit&quot; entries (less if the query</span>
<span class="sd">      completes before reading limit values).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;batch_size&#39;</span><span class="p">,</span> <span class="n">_MAX_INT_32</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

  <span class="k">class</span> <span class="nc">SortOrderEntity</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allow entity comparisons using provided orderings.</span>

<span class="sd">    The iterator passed to the constructor is eventually consumed via</span>
<span class="sd">    calls to GetNext(), which generate new SortOrderEntity s with the</span>
<span class="sd">    same orderings.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_iterator</span><span class="p">,</span> <span class="n">orderings</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Ctor.</span>

<span class="sd">      Args:</span>
<span class="sd">        entity_iterator: an iterator of entities which will be wrapped.</span>
<span class="sd">        orderings: an iterable of (identifier, order) pairs. order</span>
<span class="sd">          should be either Query.ASCENDING or Query.DESCENDING.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__entity_iterator</span> <span class="o">=</span> <span class="n">entity_iterator</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__entity</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__min_max_value_cache</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__entity</span> <span class="o">=</span> <span class="n">entity_iterator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span> <span class="o">=</span> <span class="n">orderings</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__entity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetEntity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Gets the wrapped entity.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entity</span>

    <span class="k">def</span> <span class="nf">GetNext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Wrap and return the next entity.</span>

<span class="sd">      The entity is retrieved from the iterator given at construction time.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">MultiQuery</span><span class="o">.</span><span class="n">SortOrderEntity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__entity_iterator</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CmpProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">that</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Compare two entities and return their relative order.</span>

<span class="sd">      Compares self to that based on the current sort orderings and the</span>
<span class="sd">      key orders between them. Returns negative, 0, or positive depending on</span>
<span class="sd">      whether self is less, equal to, or greater than that. This</span>
<span class="sd">      comparison returns as if all values were to be placed in ascending order</span>
<span class="sd">      (highest value last).  Only uses the sort orderings to compare (ignores</span>
<span class="sd">       keys).</span>

<span class="sd">      Args:</span>
<span class="sd">        that: SortOrderEntity</span>

<span class="sd">      Returns:</span>
<span class="sd">        Negative if self &lt; that</span>
<span class="sd">        Zero if self == that</span>
<span class="sd">        Positive if self &gt; that</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entity</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__entity</span><span class="p">,</span> <span class="n">that</span><span class="o">.</span><span class="n">__entity</span><span class="p">)</span>


      <span class="k">for</span> <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">:</span>

        <span class="n">value1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__GetValueForId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">value2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__GetValueForId</span><span class="p">(</span><span class="n">that</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="n">Query</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">:</span>
          <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">result</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">result</span>
      <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__GetValueForId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_order_entity</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">sort_order</span><span class="p">):</span>



      <span class="n">value</span> <span class="o">=</span> <span class="n">_GetPropertyValue</span><span class="p">(</span><span class="n">sort_order_entity</span><span class="o">.</span><span class="n">__entity</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">entity_key</span> <span class="o">=</span> <span class="n">sort_order_entity</span><span class="o">.</span><span class="n">__entity</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">entity_key</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__min_max_value_cache</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__min_max_value_cache</span><span class="p">[(</span><span class="n">entity_key</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">sort_order</span> <span class="o">==</span> <span class="n">Query</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__min_max_value_cache</span><span class="p">[(</span><span class="n">entity_key</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>

      <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">that</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Compare self to that w.r.t. values defined in the sort order.</span>

<span class="sd">      Compare an entity with another, using sort-order first, then the key</span>
<span class="sd">      order to break ties. This can be used in a heap to have faster min-value</span>
<span class="sd">      lookup.</span>

<span class="sd">      Args:</span>
<span class="sd">        that: other entity to compare to</span>
<span class="sd">      Returns:</span>
<span class="sd">        negative: if self is less than that in sort order</span>
<span class="sd">        zero: if self is equal to that in sort order</span>
<span class="sd">        positive: if self is greater than that in sort order</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">property_compare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CmpProperties</span><span class="p">(</span><span class="n">that</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">property_compare</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">property_compare</span>
      <span class="k">else</span><span class="p">:</span>

        <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__entity</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="n">that</span><span class="o">.</span><span class="n">__entity</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">_ExtractBounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function extracts the range of results to consider.</span>

<span class="sd">    Since MultiQuery dedupes in memory, we must apply the offset and limit in</span>
<span class="sd">    memory. The results that should be considered are</span>
<span class="sd">    results[lower_bound:upper_bound].</span>

<span class="sd">    We also pass the offset=0 and limit=upper_bound to the base queries to</span>
<span class="sd">    optimize performance.</span>

<span class="sd">    Args:</span>
<span class="sd">      config: The base datastore_query.QueryOptions.</span>

<span class="sd">    Returns:</span>
<span class="sd">      a tuple consisting of the lower_bound and upper_bound to impose in memory</span>
<span class="sd">      and the config to use with each bound query. The upper_bound may be None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">offset</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">limit</span>
    <span class="k">if</span> <span class="n">lower_bound</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lower_bound</span> <span class="o">+</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">_MAX_INT_32</span><span class="p">)</span>
      <span class="n">config</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="n">limit</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span>
                                            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">config</span>

  <span class="k">def</span> <span class="nf">__GetProjectionOverride</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a tuple of (original projection, projeciton override).</span>

<span class="sd">    If projection is None, there is no projection. If override is None,</span>
<span class="sd">    projection is sufficent for this query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span>  <span class="n">projection</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__projection</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">projection</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>



    <span class="n">override</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">projection</span><span class="p">:</span>
        <span class="n">override</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">override</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">projection</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">projection</span><span class="p">,</span> <span class="n">projection</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">Run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an iterable output with all results in order.</span>

<span class="sd">    Merge sort the results. First create a list of iterators, then walk</span>
<span class="sd">    though them and yield results in order.</span>

<span class="sd">    Args:</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      An iterator for the result set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">convert_rpc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="n">config_class</span><span class="o">=</span><span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">keys_only</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
          <span class="s">&#39;keys only queries are not supported by multi-query.&#39;</span><span class="p">)</span>


    <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ExtractBounds</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">projection</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__GetProjectionOverride</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
      <span class="n">config</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">override</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">bound_query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="s">&#39;Running query #</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
      <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bound_query</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">))</span>
      <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">GetDedupeKey</span><span class="p">(</span><span class="n">sort_order_entity</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">sort_order_entity</span><span class="o">.</span><span class="n">GetEntity</span><span class="p">()</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span>

               <span class="nb">frozenset</span><span class="p">(</span><span class="n">sort_order_entity</span><span class="o">.</span><span class="n">GetEntity</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sort_order_entity</span><span class="o">.</span><span class="n">GetEntity</span><span class="p">()</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">IterateResults</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Iterator function to return all results in sorted order.</span>

<span class="sd">      Iterate over the array of results, yielding the next element, in</span>
<span class="sd">      sorted order. This function is destructive (results will be empty</span>
<span class="sd">      when the operation is complete).</span>

<span class="sd">      Args:</span>
<span class="sd">        results: list of result iterators to merge and iterate through</span>

<span class="sd">      Yields:</span>
<span class="sd">        The next result in sorted order.</span>
<span class="sd">      &quot;&quot;&quot;</span>


      <span class="n">result_heap</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">heap_value</span> <span class="o">=</span> <span class="n">MultiQuery</span><span class="o">.</span><span class="n">SortOrderEntity</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">heap_value</span><span class="o">.</span><span class="n">GetEntity</span><span class="p">():</span>
          <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">result_heap</span><span class="p">,</span> <span class="n">heap_value</span><span class="p">)</span>





      <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>


      <span class="k">while</span> <span class="n">result_heap</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_keys</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">upper_bound</span><span class="p">:</span>

          <span class="k">break</span>
        <span class="n">top_result</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">result_heap</span><span class="p">)</span>
        <span class="n">dedupe_key</span> <span class="o">=</span> <span class="n">GetDedupeKey</span><span class="p">(</span><span class="n">top_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dedupe_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span>
          <span class="n">result</span> <span class="o">=</span> <span class="n">top_result</span><span class="o">.</span><span class="n">GetEntity</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">override</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
              <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">projection</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
          <span class="k">yield</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>

          <span class="k">pass</span>

        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dedupe_key</span><span class="p">)</span>


        <span class="n">results_to_push</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">result_heap</span><span class="p">:</span>
          <span class="nb">next</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">result_heap</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">dedupe_key</span> <span class="o">!=</span> <span class="n">GetDedupeKey</span><span class="p">(</span><span class="nb">next</span><span class="p">):</span>

            <span class="n">results_to_push</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
            <span class="k">break</span>
          <span class="k">else</span><span class="p">:</span>


            <span class="n">results_to_push</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">GetNext</span><span class="p">())</span>
        <span class="n">results_to_push</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_result</span><span class="o">.</span><span class="n">GetNext</span><span class="p">())</span>


        <span class="k">for</span> <span class="n">popped_result</span> <span class="ow">in</span> <span class="n">results_to_push</span><span class="p">:</span>


          <span class="k">if</span> <span class="n">popped_result</span><span class="o">.</span><span class="n">GetEntity</span><span class="p">():</span>
            <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">result_heap</span><span class="p">,</span> <span class="n">popped_result</span><span class="p">)</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">IterateResults</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>


    <span class="k">try</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">):</span>
        <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
      <span class="k">pass</span>

    <span class="k">return</span> <span class="n">it</span>

  <span class="k">def</span> <span class="nf">Count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the number of matched entities for this query.</span>

<span class="sd">    Will return the de-duplicated count of results.  Will call the more</span>
<span class="sd">    efficient Get() function if a limit is given.</span>

<span class="sd">    Args:</span>
<span class="sd">      limit: maximum number of entries to count (for any result &gt; limit, return</span>
<span class="sd">      limit).</span>
<span class="sd">      config: Optional Configuration to use for this request.</span>

<span class="sd">    Returns:</span>
<span class="sd">      count of the number of entries returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">convert_rpc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="n">config_class</span><span class="o">=</span><span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">)</span>

    <span class="n">projection</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__GetProjectionOverride</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">projection</span><span class="p">:</span>
      <span class="n">config</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">override</span><span class="p">:</span>
      <span class="n">config</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">QueryOptions</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">override</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>


    <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ExtractBounds</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>


    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">bound_query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">bound_query</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>

          <span class="n">dedupe_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span>
                        <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">dedupe_key</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dedupe_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_keys</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">upper_bound</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">upper_bound</span> <span class="o">-</span> <span class="n">lower_bound</span>

    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_keys</span><span class="p">)</span> <span class="o">-</span> <span class="n">lower_bound</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">GetIndexList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;No index_list available for a MultiQuery (queries &#39;</span>
                         <span class="s">&#39;using &quot;IN&quot; or &quot;!=&quot; operators)&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">GetCursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;No cursor available for a MultiQuery (queries &#39;</span>
                         <span class="s">&#39;using &quot;IN&quot; or &quot;!=&quot; operators)&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_GetCompiledQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal only, do not use.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;No compilation available for a MultiQuery (queries &#39;</span>
                         <span class="s">&#39;using &quot;IN&quot; or &quot;!=&quot; operators)&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_filter</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a new filter by setting it on all subqueries.</span>

<span class="sd">    If any of the setting operations raise an exception, the ones</span>
<span class="sd">    that succeeded are undone and the exception is propagated</span>
<span class="sd">    upward.</span>

<span class="sd">    Args:</span>
<span class="sd">      query_filter: a string of the form &quot;property operand&quot;.</span>
<span class="sd">      value: the value that the given property is compared against.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saved_items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">):</span>
      <span class="n">saved_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_filter</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">query</span><span class="p">[</span><span class="n">query_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">old_value</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">[:</span><span class="n">index</span><span class="p">],</span>
                                           <span class="n">saved_items</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">old_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">q</span><span class="p">[</span><span class="n">query_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_value</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">q</span><span class="p">[</span><span class="n">query_filter</span><span class="p">]</span>
        <span class="k">raise</span>

  <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_filter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete a filter by deleting it from all subqueries.</span>

<span class="sd">    If a KeyError is raised during the attempt, it is ignored, unless</span>
<span class="sd">    every subquery raised a KeyError. If any other exception is</span>
<span class="sd">    raised, any deletes will be rolled back.</span>

<span class="sd">    Args:</span>
<span class="sd">      query_filter: the filter to delete.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KeyError: No subquery had an entry containing query_filter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subquery_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">)</span>
    <span class="n">keyerror_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">saved_items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">saved_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_filter</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">query</span><span class="p">[</span><span class="n">query_filter</span><span class="p">]</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">keyerror_count</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">old_value</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">[:</span><span class="n">index</span><span class="p">],</span>
                                           <span class="n">saved_items</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">old_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">q</span><span class="p">[</span><span class="n">query_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_value</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">keyerror_count</span> <span class="o">==</span> <span class="n">subquery_count</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">query_filter</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bound_queries</span><span class="p">)</span>


  <span class="n">GetCompiledCursor</span> <span class="o">=</span> <span class="n">GetCursor</span>
  <span class="n">GetCompiledQuery</span> <span class="o">=</span> <span class="n">_GetCompiledQuery</span>


<span class="k">def</span> <span class="nf">RunInTransaction</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Runs a function inside a datastore transaction.</span>

<span class="sd">     Runs the user-provided function inside transaction, retries default</span>
<span class="sd">     number of times.</span>

<span class="sd">    Args:</span>
<span class="sd">      function: a function to be run inside the transaction on all remaining</span>
<span class="sd">        arguments</span>
<span class="sd">      *args: positional arguments for function.</span>
<span class="sd">      **kwargs: keyword arguments for function.</span>

<span class="sd">  Returns:</span>
<span class="sd">    the function&#39;s return value, if any</span>

<span class="sd">  Raises:</span>
<span class="sd">    TransactionFailedError, if the transaction could not be committed.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">RunInTransactionOptions</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">RunInTransactionCustomRetries</span><span class="p">(</span><span class="n">retries</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Runs a function inside a datastore transaction.</span>

<span class="sd">     Runs the user-provided function inside transaction, with a specified</span>
<span class="sd">     number of retries.</span>

<span class="sd">    Args:</span>
<span class="sd">      retries: number of retries (not counting the initial try)</span>
<span class="sd">      function: a function to be run inside the transaction on all remaining</span>
<span class="sd">        arguments</span>
<span class="sd">      *args: positional arguments for function.</span>
<span class="sd">      **kwargs: keyword arguments for function.</span>

<span class="sd">  Returns:</span>
<span class="sd">    the function&#39;s return value, if any</span>

<span class="sd">  Raises:</span>
<span class="sd">    TransactionFailedError, if the transaction could not be committed.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">options</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">RunInTransactionOptions</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">RunInTransactionOptions</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Runs a function inside a datastore transaction.</span>

<span class="sd">  Runs the user-provided function inside a full-featured, ACID datastore</span>
<span class="sd">  transaction. Every Put, Get, and Delete call in the function is made within</span>
<span class="sd">  the transaction. All entities involved in these calls must belong to the</span>
<span class="sd">  same entity group. Queries are supported as long as they specify an</span>
<span class="sd">  ancestor belonging to the same entity group.</span>

<span class="sd">  The trailing arguments are passed to the function as positional arguments.</span>
<span class="sd">  If the function returns a value, that value will be returned by</span>
<span class="sd">  RunInTransaction. Otherwise, it will return None.</span>

<span class="sd">  The function may raise any exception to roll back the transaction instead of</span>
<span class="sd">  committing it. If this happens, the transaction will be rolled back and the</span>
<span class="sd">  exception will be re-raised up to RunInTransaction&#39;s caller.</span>

<span class="sd">  If you want to roll back intentionally, but don&#39;t have an appropriate</span>
<span class="sd">  exception to raise, you can raise an instance of datastore_errors.Rollback.</span>
<span class="sd">  It will cause a rollback, but will *not* be re-raised up to the caller.</span>

<span class="sd">  The function may be run more than once, so it should be idempotent. It</span>
<span class="sd">  should avoid side effects, and it shouldn&#39;t have *any* side effects that</span>
<span class="sd">  aren&#39;t safe to occur multiple times. This includes modifying the arguments,</span>
<span class="sd">  since they persist across invocations of the function. However, this doesn&#39;t</span>
<span class="sd">  include Put, Get, and Delete calls, of course.</span>

<span class="sd">  Example usage:</span>

<span class="sd">  &gt; def decrement(key, amount=1):</span>
<span class="sd">  &gt;   counter = datastore.Get(key)</span>
<span class="sd">  &gt;   counter[&#39;count&#39;] -= amount</span>
<span class="sd">  &gt;   if counter[&#39;count&#39;] &lt; 0:    # don&#39;t let the counter go negative</span>
<span class="sd">  &gt;     raise datastore_errors.Rollback()</span>
<span class="sd">  &gt;   datastore.Put(counter)</span>
<span class="sd">  &gt;</span>
<span class="sd">  &gt; counter = datastore.Query(&#39;Counter&#39;, {&#39;name&#39;: &#39;foo&#39;})</span>
<span class="sd">  &gt; datastore.RunInTransaction(decrement, counter.key(), amount=5)</span>

<span class="sd">  Transactions satisfy the traditional ACID properties. They are:</span>

<span class="sd">  - Atomic. All of a transaction&#39;s operations are executed or none of them are.</span>

<span class="sd">  - Consistent. The datastore&#39;s state is consistent before and after a</span>
<span class="sd">  transaction, whether it committed or rolled back. Invariants such as</span>
<span class="sd">  &quot;every entity has a primary key&quot; are preserved.</span>

<span class="sd">  - Isolated. Transactions operate on a snapshot of the datastore. Other</span>
<span class="sd">  datastore operations do not see intermediated effects of the transaction;</span>
<span class="sd">  they only see its effects after it has committed.</span>

<span class="sd">  - Durable. On commit, all writes are persisted to the datastore.</span>

<span class="sd">  Nested transactions are not supported.</span>

<span class="sd">  Args:</span>
<span class="sd">    options: TransactionOptions specifying options (number of retries, etc) for</span>
<span class="sd">      this transaction</span>
<span class="sd">    function: a function to be run inside the transaction on all remaining</span>
<span class="sd">      arguments</span>
<span class="sd">      *args: positional arguments for function.</span>
<span class="sd">      **kwargs: keyword arguments for function.</span>

<span class="sd">  Returns:</span>
<span class="sd">    the function&#39;s return value, if any</span>

<span class="sd">  Raises:</span>
<span class="sd">    TransactionFailedError, if the transaction could not be committed.</span>
<span class="sd">  &quot;&quot;&quot;</span>








  <span class="n">options</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">IsInTransaction</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">propagation</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">NESTED</span><span class="p">):</span>

      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
          <span class="s">&#39;Nested transactions are not supported.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">propagation</span> <span class="ow">is</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">INDEPENDENT</span><span class="p">:</span>


      <span class="n">txn_connection</span> <span class="o">=</span> <span class="n">_PopConnection</span><span class="p">()</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RunInTransactionOptions</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">finally</span><span class="p">:</span>
        <span class="n">_PushConnection</span><span class="p">(</span><span class="n">txn_connection</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">propagation</span> <span class="ow">is</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">MANDATORY</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span><span class="s">&#39;Requires an existing transaction.&#39;</span><span class="p">)</span>


  <span class="n">retries</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">retries</span>
  <span class="k">if</span> <span class="n">retries</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="n">DEFAULT_TRANSACTION_RETRIES</span>

  <span class="n">conn</span> <span class="o">=</span> <span class="n">_GetConnection</span><span class="p">()</span>
  <span class="n">_PushConnection</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
      <span class="n">_SetConnection</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">new_transaction</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
      <span class="n">ok</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_DoOneTry</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">_PopConnection</span><span class="p">()</span>


  <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">TransactionFailedError</span><span class="p">(</span>
    <span class="s">&#39;The transaction could not be committed. Please try again.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_DoOneTry</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to call a function in a transaction, once.</span>

<span class="sd">  Args:</span>
<span class="sd">    function: The function to call.</span>
<span class="sd">    *args: Tuple of positional arguments.</span>
<span class="sd">    **kwargs: Dict of keyword arguments.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">original_exception</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>



      <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Exception sending Rollback:&#39;</span><span class="p">)</span>
    <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">original_exception</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">Rollback</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>


      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Transaction collision. Retrying... </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">_MaybeSetupTransaction</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Begin a transaction, if necessary, and populate it in the request.</span>

<span class="sd">  This API exists for internal backwards compatibility, primarily with</span>
<span class="sd">  api/taskqueue/taskqueue.py.</span>

<span class="sd">  Args:</span>
<span class="sd">    request: A protobuf with a mutable_transaction() method.</span>
<span class="sd">    keys: Unused.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A transaction if we&#39;re inside a transaction, otherwise None</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">_GetConnection</span><span class="p">()</span><span class="o">.</span><span class="n">_set_request_transaction</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">IsInTransaction</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;Determine whether already running in transaction.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if already running in transaction, else False.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_GetConnection</span><span class="p">(),</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionalConnection</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Transactional</span><span class="p">(</span><span class="n">_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A decorator that makes sure a function is run in a transaction.</span>

<span class="sd">  Defaults propagation to datastore_rpc.TransactionOptions.ALLOWED, which means</span>
<span class="sd">  any existing transaction will be used in place of creating a new one.</span>

<span class="sd">  WARNING: Reading from the datastore while in a transaction will not see any</span>
<span class="sd">  changes made in the same transaction. If the function being decorated relies</span>
<span class="sd">  on seeing all changes made in the calling scoope, set</span>
<span class="sd">  propagation=datastore_rpc.TransactionOptions.NESTED.</span>

<span class="sd">  Args:</span>
<span class="sd">    _func: do not use.</span>
<span class="sd">    **kwargs: TransactionOptions configuration options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A wrapper for the given function that creates a new transaction if needed.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="n">_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Transactional</span><span class="p">()(</span><span class="n">_func</span><span class="p">)</span>


  <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;require_new&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>

    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;propagation&#39;</span><span class="p">,</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">ALLOWED</span><span class="p">)</span>

  <span class="n">options</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">outer_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">RunInTransactionOptions</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inner_wrapper</span>
  <span class="k">return</span> <span class="n">outer_wrapper</span>


<span class="nd">@datastore_rpc._positional</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">NonTransactional</span><span class="p">(</span><span class="n">_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_existing</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A decorator that insures a function is run outside a transaction.</span>

<span class="sd">  If there is an existing transaction (and allow_existing=True), the existing</span>
<span class="sd">  transaction is paused while the function is executed.</span>

<span class="sd">  Args:</span>
<span class="sd">    _func: do not use</span>
<span class="sd">    allow_existing: If false, throw an exception if called from within a</span>
<span class="sd">      transaction</span>

<span class="sd">  Returns:</span>
<span class="sd">    A wrapper for the decorated function that ensures it runs outside a</span>
<span class="sd">    transaction.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="n">_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">NonTransactional</span><span class="p">()(</span><span class="n">_func</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">outer_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">IsInTransaction</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_existing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
            <span class="s">&#39;Function cannot be called from within a transaction.&#39;</span><span class="p">)</span>



      <span class="n">txn_connection</span> <span class="o">=</span> <span class="n">_PopConnection</span><span class="p">()</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
      <span class="k">finally</span><span class="p">:</span>
        <span class="n">_PushConnection</span><span class="p">(</span><span class="n">txn_connection</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inner_wrapper</span>
  <span class="k">return</span> <span class="n">outer_wrapper</span>


<span class="k">def</span> <span class="nf">_GetCompleteKeyOrError</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Expects an Entity or a Key, and returns the corresponding Key. Raises</span>
<span class="sd">  BadArgumentError or BadKeyError if arg is a different type or is incomplete.</span>

<span class="sd">  Args:</span>
<span class="sd">    arg: Entity or Key</span>

<span class="sd">  Returns:</span>
<span class="sd">    Key</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">arg</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
  <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
      <span class="s">&#39;Expects argument to be an Entity or Key; received </span><span class="si">%s</span><span class="s"> (a </span><span class="si">%s</span><span class="s">).&#39;</span> <span class="o">%</span>
      <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">typename</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Key</span><span class="p">)</span>


  <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">():</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadKeyError</span><span class="p">(</span><span class="s">&#39;Key </span><span class="si">%r</span><span class="s"> is not complete.&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">key</span>


<span class="k">def</span> <span class="nf">_GetPropertyValue</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns an entity&#39;s value for a given property name.</span>

<span class="sd">  Handles special properties like __key__ as well as normal properties.</span>

<span class="sd">  Args:</span>
<span class="sd">    entity: datastore.Entity</span>
<span class="sd">    property: str; the property name</span>

<span class="sd">  Returns:</span>
<span class="sd">    property value. For __key__, a datastore_types.Key.</span>

<span class="sd">  Raises:</span>
<span class="sd">    KeyError, if the entity does not have the given property.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">property</span> <span class="ow">in</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_SPECIAL_PROPERTIES</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">property</span> <span class="o">==</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_UNAPPLIED_LOG_TIMESTAMP_SPECIAL_PROPERTY</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="nb">property</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">property</span> <span class="o">==</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span>
    <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">entity</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_AddOrAppend</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Adds the value to the existing values in the dictionary, if any.</span>

<span class="sd">  If dictionary[key] doesn&#39;t exist, sets dictionary[key] to value.</span>

<span class="sd">  If dictionary[key] is not a list, sets dictionary[key] to [old_value, value].</span>

<span class="sd">  If dictionary[key] is a list, appends value to that list.</span>

<span class="sd">  Args:</span>
<span class="sd">    dictionary: a dict</span>
<span class="sd">    key, value: anything</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="p">:</span>
    <span class="n">existing_value</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">existing_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
      <span class="n">existing_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">existing_value</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">Iterator</span><span class="p">(</span><span class="n">datastore_query</span><span class="o">.</span><span class="n">ResultsIterator</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Thin wrapper of datastore_query.ResultsIterator.</span>

<span class="sd">  Deprecated, do not use, only for backwards compatability.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_Next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">count</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="k">def</span> <span class="nf">GetCompiledCursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">GetIndexList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the list of indexes used to perform the query.&quot;&quot;&quot;</span>
    <span class="n">tuple_index_list</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Iterator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">index_list</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">tuple_index_list</span><span class="p">]</span>

  <span class="n">_Get</span> <span class="o">=</span> <span class="n">_Next</span>



  <span class="n">index_list</span> <span class="o">=</span> <span class="n">GetIndexList</span>



<span class="n">DatastoreRPC</span> <span class="o">=</span> <span class="n">apiproxy_stub_map</span><span class="o">.</span><span class="n">UserRPC</span>
<span class="n">GetRpcFromKwargs</span> <span class="o">=</span> <span class="n">_GetConfigFromKwargs</span>
<span class="n">_CurrentTransactionKey</span> <span class="o">=</span> <span class="n">IsInTransaction</span>
<span class="n">_ToDatastoreError</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">_ToDatastoreError</span>
<span class="n">_DatastoreExceptionFromErrorCodeAndDetail</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">_DatastoreExceptionFromErrorCodeAndDetail</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Google, Inc.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.4.6',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>